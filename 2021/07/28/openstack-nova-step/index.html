<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>openstack nova 创建虚拟机步骤 &mdash; 阿嫂</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/rouge-themes@master/dist/github.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/share.js/dist/css/share.min.css"><link rel="canonical" href="https://lewinz.org/2021/07/28/openstack-nova-step/"><link rel="alternate" type="application/atom+xml" title="阿嫂" href="https://lewinz.org/feed.xml"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/favicon.ico"><meta property="og:title" content="openstack nova 创建虚拟机步骤"><meta name="keywords" content="openstack, nova"><meta name="og:keywords" content="openstack, nova"><meta name="description" content="nova 创建虚机总流程"><meta name="og:description" content="nova 创建虚机总流程"><meta property="og:url" content="https://lewinz.org/2021/07/28/openstack-nova-step/"><meta property="og:site_name" content="阿嫂"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-07-28"> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/main.js"></script> <script data-ad-client="ca-pub-7093222719567591" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://lewinz.org/" title="阿嫂"><span class="octicon octicon-mark-github"></span> 阿嫂</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://lewinz.org/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://lewinz.org/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://lewinz.org/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://lewinz.org/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://lewinz.org/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="openstack nova "><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">openstack nova 创建虚拟机步骤</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/07/28 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://lewinz.org/categories/#openstack" title="openstack">openstack</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://lewinz.org/categories/#nova" title="nova">nova</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 7686 字，约 22 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" > <ins class="adsbygoogle content-header-ad" data-ad-client="ca-pub-7093222719567591" data-ad-slot="1650902835"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br /><article class="article-content markdown-body"><h2 id="nova-创建虚机总流程">nova 创建虚机总流程</h2><p><img src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/images/posts/openstack_nova_step_1.png" alt="openstack_nova_step" /></p><h3 id="nova-创建虚机请求流">nova 创建虚机请求流</h3><ol><li>Dashboard 或者 CLI 获取用户的登录信息，调用 Keystone 的 REST API 去做用户身份验证。</li><li>Keystone 对用户登录信息进行校验，然后产生验证 token 并发回。它会被用于后续 REST 调用请求。</li><li>Dashboard 或者 CLI 将创建虚机的 REST 请求中的‘launch instance’ 或‘nova-boot’ 部分进行转换，然后调用 nova-api 的 REST 接口。</li><li>nova-api 接到请求，向 keystone 发送 auth-token 校验和权限认证请求。</li><li>Keystone 校验 token，并将 auth headers 发回，它包括了 roles 和 permissions。</li><li>nova-api 和 nova-database 进行交互。</li><li>nova-database 为新实例创建一个数据库条目。</li><li>nova-api 向 nova-scheduler 发送 rpc.call 请求，期望它能通过附带的 host ID 获取到数据库条目。</li><li>nova-scheduler 从 queue 中获取到请求。</li><li>nova-scheduler 和 nova-database 交互，获取集群中计算节点的信息和状态。</li><li>nova-scheuler 通过过滤（filtering）和称重（weighting）找到一个合适的计算节点（host）。</li><li>nova-scheduler 向找到的那个 host 上的 nova-compute 发送 rpc.cast 请求去启动虚机。</li><li>目标 host 上的 nova-compute 从 queue 中获取到请求。</li><li>nova-compute 向 nova-condutor 发送 rpc.call 请求去获取待创建虚机的信息比如 host ID 和 flavor 等。</li><li>nova-conductor 从 queue 中获取到请求。</li><li>nova-conductor 和 nova-database 交互。</li><li>nova-database 向 nova-conductor 返回虚机的信息。</li><li>nova-conductor 向 nova-compute 发送 rpc.call，附带所请求的信息。图中应该是遗漏了一个步骤，就是 nova-compute 从 queue 中获取返回的数据。</li><li>nova-compute 调用 glance-api 的 REST API，传入 auth-token，去根据镜像 ID 获取镜像 URI，从镜像存储中下载（原文为 upload）镜像。</li><li>glance-api 向 keystone 校验 auth-token。</li><li>nova-compute 获取 image 的元数据。</li><li>nova-compute 调用 Neutron API ，传入 auth-token，去分配和配置网络，比如虚机的 IP 地址。</li><li>neutron-server 通过 keystone 校验 auth-token。</li><li>nova-compute 获得网络信息。</li><li>nova-compute 调用 Cinder API，传入 auth-token，去将 volume 挂接到实例。</li><li>cinder-api 通过 keystone 校验 auth-token。</li><li>nova-compute 获得块存储信息。</li><li>nova-compute 为 hypervisor driver 产生数据，并调用 Hypersior 执行请求（通过 libvirt 或者 api）。</li></ol><h3 id="下表列出了每个步骤中实例的状态">下表列出了每个步骤中实例的状态：</h3><table><thead><tr><th>Status</th><th>Task</th><th>Power state</th><th>Steps</th></tr></thead><tbody><tr><td>Build</td><td>scheduling</td><td>None</td><td>3-12</td></tr><tr><td>Build</td><td>networking</td><td>None</td><td>22-24</td></tr><tr><td>Build</td><td>block_device_mapping</td><td>None</td><td>25-27</td></tr><tr><td>Build</td><td>spawing</td><td>None</td><td>28</td></tr><tr><td>Active</td><td>none</td><td>Running</td><td> </td></tr></tbody></table><h2 id="nova-compute-接到指令后开始创建虚机的代码分析-第-19-步之后">nova compute 接到指令后开始创建虚机的代码分析 （第 19 步之后）</h2><p>代码在 <code class="language-plaintext highlighter-rouge">https://github.com/openstack/nova/blob/master/nova/compute/manager.py</code> 中的 def _build_and_run_instance 函数中：</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_build_resources</span> <span class="o">//</span> <span class="n">准备网络和磁盘</span>
    <span class="o">//</span><span class="n">Start</span> <span class="n">building</span> <span class="n">networks</span> <span class="n">asynchronously</span> <span class="k">for</span> <span class="n">instance</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">_build_networks_for_instance</span> <span class="o">//</span><span class="n">为</span> <span class="n">instance</span> <span class="n">准备网络资源</span><span class="err">，</span><span class="n">实际上是创建一个</span> <span class="n">neutron</span> <span class="n">port</span>
        <span class="n">macs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">macs_for_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="o">//</span><span class="n">分配</span> <span class="n">mac</span> <span class="n">地址</span><span class="err">。</span><span class="n">多绝大多数</span> <span class="n">hypersivor</span><span class="err">，</span><span class="n">返回</span> <span class="bp">None</span><span class="err">，</span><span class="n">也就是不预先分配</span>
        <span class="n">network_info</span> <span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">_allocate_network</span> <span class="o">//</span><span class="n">开始异步网络分配</span>
            <span class="n">nwinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">network_api</span><span class="p">.</span><span class="n">allocate_for_instance</span> <span class="o">//</span><span class="n">Allocate</span> <span class="n">network</span> <span class="n">resources</span> <span class="k">for</span> <span class="n">the</span> <span class="n">instance</span>
                <span class="n">_validate_requested_port_ids</span> <span class="o">//</span><span class="n">校验</span> <span class="n">port</span> <span class="n">ids</span>
                <span class="n">_validate_requested_network_ids</span> <span class="o">//</span><span class="n">校验</span> <span class="n">network</span> <span class="n">ids</span>
                <span class="n">_clean_security_groups</span> <span class="o">//</span><span class="n">删除</span> <span class="n">default</span> <span class="n">安全组</span>
                <span class="n">_process_security_groups</span> <span class="o">//</span><span class="n">Processes</span> <span class="ow">and</span> <span class="n">validates</span> <span class="n">requested</span> <span class="n">security</span> <span class="n">groups</span> <span class="k">for</span> <span class="n">allocation</span>
                <span class="n">_create_ports_for_instance</span> <span class="o">//</span><span class="n">Create</span> <span class="n">port</span> <span class="k">for</span> <span class="n">network_requests</span> <span class="n">that</span> <span class="n">don</span><span class="s">'t have a port_id
                    _create_port_minimal //如果 port 没有的话，则 Attempts to create a port for the instance on the given network.
                        port_client.create_port //调用 port api 来创建 port，包括创建 port，分配 MAC 及 IP 地址，更新数据库
                            _generate_mac //生成 MAC 地址
                            _create_port_with_mac //创建 port
                                //DHCP 相关操作：port 创建完成后会通知 neutron-dhcp-agent 去执行 port_create_end 函数，它会将 port 的 ip 和 mac 信息加载到 dnsmasq 所需的配置文件中
                            _allocate_ips_for_port //为 port 分配 IP，要么用户有指定，要么从 subnets 中选择一个
                                _allocate_specific_ip //如果指定了 IP
                                _generate_ip //如果没指定 IP
                    return requests_and_created_ports
                _update_ports_for_instance //为特殊 case 更新 port
                    _populate_neutron_extension_values
                    _populate_pci_mac_address //只用于处理 SRIOV_PF
                    _populate_mac_address
                    _update_port
                        port_client.update_port //将上述修改通过调用 port api 得以更新 port
                    _update_port_dns_name
                        neutron.update_port(port_id, port_req_body) //将 port 的 dns_name 设置为 hostname
                nw_info = self.get_instance_nw_info
                    _build_network_info_model //Return list of ordered VIFs attached to instance
                        _gather_port_ids_and_networks //Return an instance'</span><span class="n">s</span> <span class="n">complete</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">port_ids</span> <span class="ow">and</span> <span class="n">networks</span>
                            <span class="n">ifaces</span> <span class="o">=</span> <span class="n">instance</span><span class="p">.</span><span class="n">get_network_info</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">nw_info</span>

    <span class="o">//</span><span class="n">Start</span> <span class="n">building</span> <span class="n">block</span> <span class="n">device</span> <span class="n">mappings</span> <span class="k">for</span> <span class="n">instance</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">_prep_block_device</span> <span class="o">//</span><span class="n">Set</span> <span class="n">up</span> <span class="n">the</span> <span class="n">block</span> <span class="n">device</span> <span class="k">for</span> <span class="n">an</span> <span class="n">instance</span> <span class="k">with</span> <span class="n">error</span> <span class="n">logging</span>
        <span class="n">block_device_info</span> <span class="o">=</span> <span class="n">driver</span><span class="p">.</span><span class="n">get_block_device_info</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">bdms</span><span class="p">)</span> <span class="o">//</span><span class="n">Converts</span> <span class="n">block</span> <span class="n">device</span> <span class="n">mappings</span> <span class="k">for</span> <span class="n">instance</span> <span class="n">to</span> <span class="n">driver</span> <span class="nb">format</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="n">driver</span><span class="p">.</span><span class="n">block_device_info_get_mapping</span><span class="p">(</span><span class="n">block_device_info</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">block_device_mapping</span>
        <span class="n">driver_block_device</span><span class="p">.</span><span class="n">attach_block_devices</span> <span class="o">//</span><span class="n">nova</span><span class="o">/</span><span class="n">virt</span><span class="o">/</span><span class="n">block_device</span><span class="p">.</span><span class="n">py</span>
            <span class="n">_log_and_attach</span>
                <span class="o">//</span><span class="n">首先找出</span> <span class="n">instance</span> <span class="n">将从哪里启动</span><span class="err">，</span><span class="n">可能从</span> <span class="n">volume</span><span class="err">，</span><span class="n">snapshot</span><span class="err">，</span><span class="n">image</span> <span class="n">上启动</span>
                <span class="n">bdm</span><span class="p">.</span><span class="n">attach</span> <span class="o">//</span><span class="n">真正做</span> <span class="n">attach</span> <span class="n">操作</span>
        <span class="n">_block_device_info_to_legacy</span>
        <span class="k">return</span> <span class="n">block_device_info</span>

<span class="bp">self</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">spawn</span> <span class="o">//</span><span class="n">调用</span> <span class="n">nova</span><span class="o">/</span><span class="n">virt</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">driver</span><span class="p">.</span><span class="n">py</span> <span class="n">中的</span> <span class="n">spawn</span> <span class="n">函数</span><span class="err">，</span><span class="n">首先创建</span> <span class="n">image</span><span class="err">，</span><span class="n">然后创建</span> <span class="n">domain</span>
       <span class="n">disk_info</span> <span class="o">=</span> <span class="n">blockinfo</span><span class="p">.</span><span class="n">get_disk_info</span>
       <span class="n">_create_configdrive</span>
       <span class="n">_create_image</span> <span class="o">//</span><span class="n">创建镜像</span>
           <span class="n">libvirt_utils</span><span class="p">.</span><span class="n">fetch_raw_image</span>
               <span class="n">IMAGE_API</span><span class="p">.</span><span class="n">download</span> <span class="o">//</span><span class="n">调用</span> <span class="n">glance</span> <span class="n">API</span> <span class="n">去下载镜像</span>
           <span class="n">_create_and_inject_local_root</span> <span class="o">//</span><span class="n">做文件注入</span>
           <span class="n">_create_ephemeral</span>
               <span class="n">libvirt_utils</span><span class="p">.</span><span class="n">create_image</span><span class="p">(</span><span class="s">'raw'</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="s">'%dG'</span> <span class="o">%</span> <span class="n">ephemeral_size</span><span class="p">)</span>
                   <span class="n">utils</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'qemu-img'</span><span class="p">,</span> <span class="s">'create'</span><span class="p">,</span> <span class="s">'-f'</span><span class="p">,</span> <span class="n">disk_format</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
           <span class="n">_create_swap</span>
               <span class="n">libvirt_utils</span><span class="p">.</span><span class="n">create_image</span><span class="p">(</span><span class="s">'raw'</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="s">'%dM'</span> <span class="o">%</span> <span class="n">swap_mb</span><span class="p">)</span>
               <span class="n">nova</span><span class="p">.</span><span class="n">privsep</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">unprivileged_mkfs</span><span class="p">(</span><span class="s">'swap'</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
       <span class="n">xml</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_guest_xml</span> <span class="o">//</span><span class="n">生成</span> <span class="n">domain</span> <span class="n">xml</span> <span class="n">字符串</span>
           <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_guest_config</span>
               <span class="n">_get_guest_numa_config</span>
               <span class="n">_get_guest_memory_backing_config</span>
               <span class="n">_get_guest_config_meta</span>
               <span class="n">_update_guest_cputune</span>
               <span class="n">_cpu_config_to_vcpu_model</span>
               <span class="n">_configure_guest_by_virt_type</span>
               <span class="n">_set_features</span>
               <span class="n">_set_clock</span>
               <span class="n">_get_guest_storage_config</span>
               <span class="bp">self</span><span class="p">.</span><span class="n">vif_driver</span><span class="p">.</span><span class="n">get_config</span>
               <span class="n">_create_consoles</span>
               <span class="n">_guest_add_spice_channel</span>
               <span class="n">_add_video_driver</span>
               <span class="n">_set_qemu_guest_agent</span>
               <span class="n">_guest_add_pci_devices</span>
               <span class="n">_guest_add_watchdog_action</span>
               <span class="n">_guest_add_memory_balloon</span>
               <span class="n">_guest_add_mdevs</span>
               <span class="k">return</span> <span class="n">guest</span>
           <span class="n">xml</span> <span class="o">=</span> <span class="n">conf</span><span class="p">.</span><span class="n">to_xml</span><span class="p">()</span>
           <span class="k">return</span> <span class="n">xml</span>

       <span class="bp">self</span><span class="p">.</span><span class="n">_create_domain_and_network</span>
           <span class="o">//</span><span class="n">nova</span> <span class="n">侧去等待</span> <span class="n">neutron</span> <span class="n">侧发送</span> <span class="n">network</span><span class="o">-</span><span class="n">vif</span><span class="o">-</span><span class="n">pluggend</span> <span class="n">事件</span><span class="err">。</span><span class="n">neutron</span><span class="o">-</span><span class="n">linuxbridge</span><span class="o">-</span><span class="n">agent</span> <span class="n">服务检测</span> <span class="n">tap</span> <span class="n">设备</span><span class="err">，</span><span class="n">neutron</span><span class="o">-</span><span class="n">server</span> <span class="n">发送</span> <span class="n">event</span> <span class="n">事件给</span> <span class="n">nova</span><span class="o">-</span><span class="n">api</span>
           <span class="bp">self</span><span class="p">.</span><span class="n">virtapi</span><span class="p">.</span><span class="n">wait_for_instance_event</span>
           <span class="bp">self</span><span class="p">.</span><span class="n">plug_vifs</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">network_info</span><span class="p">)</span>
           <span class="bp">self</span><span class="p">.</span><span class="n">firewall_driver</span><span class="p">.</span><span class="n">setup_basic_filtering</span>
           <span class="bp">self</span><span class="p">.</span><span class="n">firewall_driver</span><span class="p">.</span><span class="n">prepare_instance_filter</span>
           <span class="bp">self</span><span class="p">.</span><span class="n">_create_domain</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
               <span class="n">libvirt_guest</span><span class="p">.</span><span class="n">Guest</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">_host</span><span class="p">)</span>
                   <span class="n">write_instance_config</span> <span class="o">//</span> <span class="n">nova</span><span class="o">/</span><span class="n">virt</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">host</span><span class="p">.</span><span class="n">py</span> <span class="n">中</span>
                   <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_connection</span><span class="p">().</span><span class="n">defineXML</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
                   <span class="k">return</span> <span class="n">libvirt_guest</span><span class="p">.</span><span class="n">Guest</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
               <span class="k">return</span> <span class="n">guest</span>
      <span class="n">_wait_for_boot</span>   <span class="o">//</span><span class="n">每隔</span> <span class="mf">0.5</span> <span class="n">秒检查虚机是否启动</span>
<span class="n">_update_instance_after_spawn</span>
<span class="n">_update_scheduler_instance_info</span>
    <span class="n">scheduler_client</span><span class="p">.</span><span class="n">update_instance_info</span>
<span class="n">_notify_about_instance_usage</span>
</code></pre></div></div><h3 id="补充">补充：</h3><ul><li>port 创建成功后的 dhcp 相关操作（参考 <a href="https://blog.csdn.net/gj19890923/article/details/51558598">https://blog.csdn.net/gj19890923/article/details/51558598</a>）：<ul><li>创建 VM 时，nova-compute 与 neutron 的 plugin 交互，在 neutron 的数据库中创建 VM 所需的 port 信息。</li><li>neutron 数据库中的 port 信息创建完成后，通知 neutron-dhcp-agent 去执行 port_create_end 函数。该函数将数据库中的 port 中的 ip 和 mac 信息加载到 dnsmasq 所需的配置文件中 (包括 host 和 addn_hosts 文件)。</li></ul></li></ul><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@nova 43c0e274-28e3-482e-a32b-d783980fc3ed]# <span class="nb">cat </span>addn_hosts

  1.1.1.1 host-1-1-1-1.openstacklocal host-1-1-1-1

  1.1.1.2 host-1-1-1-2.openstacklocal host-1-1-1-2

  1.1.1.10        host-1-1-1-10.openstacklocal host-1-1-1-10

<span class="o">[</span>root@nova 43c0e274-28e3-482e-a32b-d783980fc3ed]# <span class="nb">cat </span>host

  fa:16:3e:d1:d7:72,host-1-1-1-1.openstacklocal,1.1.1.1

  fa:16:3e:da:42:50,host-1-1-1-2.openstacklocal,1.1.1.2

  fa:16:3e:3c:a3:3e,host-1-1-1-10.openstacklocal,1.1.1.10
<span class="o">[</span>root@nova 43c0e274-28e3-482e-a32b-d783980fc3ed]# <span class="nb">cat </span>leases

  1464599134 fa:16:3e:3c:a3:3e 1.1.1.10 host-1-1-1-10 01:fa:16:3e:3c:a3:3e

  1464598886 fa:16:3e:da:42:50 1.1.1.2 host-1-1-1-2 <span class="k">*</span>

  1464598886 fa:16:3e:d1:d7:72 1.1.1.1 host-1-1-1-1 <span class="k">*</span>
</code></pre></div></div><ul><li><p>在 VM 启动时，广播 dhcp discover 请求，当 dnsmasq 进程的监听接口 ns-xxx 监听到这种请求时，dnsmasq 进程将根据配置文件 (host 和 leases 文件) 中的内容去判定是否有未分配的 ip 和 mac 为请求者进行提供。</p></li><li><p>最终 VM 便真实的获取到与保存在数据库中的 ip 和 mac 信息。neutron-dhcp-agent 只是将所创建 VM 的 ip 和 mac 信息从数据库中获取到自己的配置文件中，然后等到 VM 启动时，为它提供。因此 neutron-dhcp-agent 相当于在 VM 和数据库之间起了个中间桥梁的作用。</p></li><li><p>nova 在 domain 被创建后等待 neutron event 的过程（请参考 <a href="http://www.aichengxu.com/linux/9307663.htm">http://www.aichengxu.com/linux/9307663.htm</a>）</p><ul><li>创建 VM 时， nova-compute 服务调用 wait_for_instance_event 函数等待 neutron 侧发送 event 事件。</li><li>neutron 的 neutron-linuxbridge-agent 定时检测 tap 设备的增加或删除，当创建 VM 时，将创建新的 tap 设备，此时将更新 neutron 数据库中的 ports 表，而 neutron-server 服务创建 core_plugin 时，将利用 sqlalchemy 自带的 event 对 neutron 数据库中的 ports 表进行监视，当 ports 表发生变化时，neutron-server 将通过 HTTP 请求的方式发送 event 事件给 nova。</li><li>nova 侧收到 neutron 侧发送的 event 事件，便结束等待，继续创建 VM 下面的操作。</li></ul></li></ul><h2 id="虚机被创建后的-l2-网络操作">虚机被创建后的 L2 网络操作</h2><p>虚机被创建后，nova-compute 节点上的 neutron-linuxbridge-agent 会检测到新建的 tap 设备（通过轮询 /sys/class/net/ 里面的 tap 设备），找到后则执行一系列网络方面的操作，包括设置安全组，</p><p>tap 设备示例：</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@test net]# <span class="nb">ls
</span>brq8165bc3d-40 eth0 eth1 eth1.120 eth2 lo tap712a2c63-e6 tap83e7c095-f0 tap8f4fcfbb-2b
</code></pre></div></div><p>tap 设备信息：</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Port tap93121330-58 updated. Details: <span class="o">{</span>u<span class="s1">'profile'</span>: <span class="o">{}</span>, u<span class="s1">'allowed_address_pairs'</span>: <span class="o">[]</span>, u<span class="s1">'admin_state_up'</span>: True, u<span class="s1">'network_id'</span>: u<span class="s1">'8165bc3d-400a-48a0-9186-bf59f7f94b05'</span>, u<span class="s1">'segmentation_id'</span>: 120,u<span class="s1">'device_owner'</span>: u<span class="s1">'compute:nova'</span>,
u<span class="s1">'physical_network'</span>: u<span class="s1">'physnet1'</span>, u<span class="s1">'mac_address'</span>: u<span class="s1">'fa:16:3e:9f:6f:c5'</span>, u<span class="s1">'device'</span>: u<span class="s1">'tap93121330-58'</span>, u<span class="s1">'port_security_enabled'</span>: True, u<span class="s1">'port_id'</span>: u<span class="s1">'93121330-58'</span>, u<span class="s1">'fixed_ips'</span>: <span class="o">[{</span>u<span class="s1">'subnet_id'</span>: u<span class="s1">'ec1028b2-7cb0-4feb-b974-6b8ea7e7f08f'</span>, u<span class="s1">'ip_address'</span>: u<span class="s1">'172.16.0.7'</span><span class="o">}]</span>,
u<span class="s1">'network_type'</span>: u<span class="s1">'vlan'</span><span class="o">}</span>
</code></pre></div></div><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://lewinz.org" target="_blank">Lewin</a></li><li>本文链接：<a href="https://lewinz.org/2021/07/28/openstack-nova-step/" target="_blank">https://lewinz.org/2021/07/28/openstack-nova-step/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名</li></ul></div></article><div class="share"><div class="share-component" data-disabled='qq,weibo,qzone'></div></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2021/07/28/openstack-nova-step/', clientID: '831a35f6d4f6fc049209', clientSecret: '6e80f9a3e9b50b498553e32179ad3adbd893ab7e', repo: 'blog-comments', owner: 'Lewinz', admin: ['Lewinz'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@built/assets/search_data.json?v=1628005560', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7093222719567591" data-ad-slot="5263168187" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2021 <span title="Lewin">Lewin</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/Lewinz/lewinz.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://lewinz.org/" title="首页" target="">首页</a></li><li> <a href="https://lewinz.org/categories/" title="分类" target="">分类</a></li><li> <a href="https://lewinz.org/wiki/" title="维基" target="">维基</a></li><li> <a href="https://lewinz.org/links/" title="链接" target="">链接</a></li><li> <a href="https://lewinz.org/about/" title="关于" target="">关于</a></li><li><a href="https://lewinz.org/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul><script async src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span> <span id="busuanzi_container_page_pv" style="display:none"> / 本页访问量<span id="busuanzi_value_page_pv"></span>次 / 统计始于2021-04-21 </span></div></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/share.js/dist/js/share.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-80669434-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
