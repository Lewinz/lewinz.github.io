<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>Linux systemd && systemctl &mdash; 阿嫂</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/rouge-themes@master/dist/github.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/share.js/dist/css/share.min.css"><link rel="canonical" href="https://lewinz.org/2021/07/12/linux-systemctl/"><link rel="alternate" type="application/atom+xml" title="阿嫂" href="https://lewinz.org/feed.xml"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/favicon.ico"><meta property="og:title" content="Linux systemd && systemctl"><meta name="keywords" content="linux, 自启动, systemd, systemctl"><meta name="og:keywords" content="linux, 自启动, systemd, systemctl"><meta name="description" content="systemd 文件夹配置文件夹systemd 配置文件存在于以下三个文件夹中："><meta name="og:description" content="systemd 文件夹配置文件夹systemd 配置文件存在于以下三个文件夹中："><meta property="og:url" content="https://lewinz.org/2021/07/12/linux-systemctl/"><meta property="og:site_name" content="阿嫂"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-07-12"> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/main.js"></script> <script data-ad-client="ca-pub-7093222719567591" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://lewinz.org/" title="阿嫂"><span class="octicon octicon-mark-github"></span> 阿嫂</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://lewinz.org/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://lewinz.org/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://lewinz.org/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://lewinz.org/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://lewinz.org/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="Linux systemd &"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">Linux systemd && systemctl</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/07/12 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://lewinz.org/categories/#linux" title="linux">linux</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://lewinz.org/categories/#自启动" title="自启动">自启动</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://lewinz.org/categories/#systemd" title="systemd">systemd</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://lewinz.org/categories/#systemctl" title="systemctl">systemctl</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 2482 字，约 8 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" > <ins class="adsbygoogle content-header-ad" data-ad-client="ca-pub-7093222719567591" data-ad-slot="1650902835"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br /><article class="article-content markdown-body"><h2 id="systemd-文件夹配置文件夹">systemd 文件夹配置文件夹</h2><p>systemd 配置文件存在于以下三个文件夹中：</p><ul><li><code class="language-plaintext highlighter-rouge">/etc/systemd/system</code> 存放系统启动的默认级别及启动的 unit 的软连接，优先级最高</li><li><code class="language-plaintext highlighter-rouge">/run/systemd/system</code> 系统执行过程中产生的服务脚本，优先级次之</li><li><code class="language-plaintext highlighter-rouge">/usr/lib/systemd/system</code> 存放系统上所有的启动文件。优先级最低</li></ul><h2 id="unit-分类">unit 分类</h2><p>unit 的定义文件可以根据其后缀名称识别其定义的类型，可以使用 systemctl -t help 查看。</p><ul><li><code class="language-plaintext highlighter-rouge">.servicre</code> 定义了系统服务的启动</li><li><code class="language-plaintext highlighter-rouge">.target</code> 定义了系统启动的级别标签，systemd 没有运行级别的概念，创建标签只是为了兼容老版本。</li><li><code class="language-plaintext highlighter-rouge">.socket</code> 定义了进程通信用到的套接字，套接字与进程是分离的</li><li><code class="language-plaintext highlighter-rouge">.device</code> 定义了系统启动时内核识别的文件，systemd 提供了设备的管理功能，/dev 下的设备由 /etc/udev/ 下的配置文件与.device 共同定制</li><li><code class="language-plaintext highlighter-rouge">.mount</code> 定义了系统的文件系统的挂载点</li><li><code class="language-plaintext highlighter-rouge">.snapshop</code> 系统快照</li><li><code class="language-plaintext highlighter-rouge">.swap</code> 用于标识 swap 设备</li><li><code class="language-plaintext highlighter-rouge">.automount</code> 文件系统的自动挂载点</li><li><code class="language-plaintext highlighter-rouge">.path</code> 用于定义文件系统中的一个文件或目录使用。常用于文件系统发生变化时，延迟激活服务。</li></ul><h2 id="文件组成">文件组成</h2><p>文件通常由 3 段组成：</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]

<span class="o">[</span>unit 的类型：service target socket]

<span class="o">[</span><span class="nb">install</span><span class="o">]</span>
</code></pre></div></div><h3 id="unit">[Unit]</h3><p>不属于第二个标签的定义都放在这里，或存放不属于 unit 类型的定义，描述信息，依赖的 unit</p><ul><li><code class="language-plaintext highlighter-rouge">Description</code>：描述信息</li><li><code class="language-plaintext highlighter-rouge">After</code>：表明需要依赖的服务，作用决定启动顺序</li><li><code class="language-plaintext highlighter-rouge">Before</code>：表明被依赖的服务</li><li><code class="language-plaintext highlighter-rouge">Requles</code>：依赖到的其他 unit ，强依赖，即依赖的 unit 启动失败。该 unit 不启动。</li><li><code class="language-plaintext highlighter-rouge">Wants</code>：依赖到的其他 unit，弱依赖，即依赖的 unit 启动失败。该 unit 继续启动</li><li><code class="language-plaintext highlighter-rouge">Conflicts</code>：定义冲突关系</li></ul><h3 id="unit-类型">[Unit 类型]</h3><h4 id="service">[Service]：</h4><ul><li><code class="language-plaintext highlighter-rouge">type</code>：启动时关系的定义，<ul><li><code class="language-plaintext highlighter-rouge">simple</code>：(当设置了 <code class="language-plaintext highlighter-rouge">ExecStart=</code> 、 但是没有设置 <code class="language-plaintext highlighter-rouge">Type=</code> 与 <code class="language-plaintext highlighter-rouge">BusName=</code> 时，这是默认值)， 那么 <code class="language-plaintext highlighter-rouge">ExecStart=</code> 进程就是该服务的主进程</li><li><code class="language-plaintext highlighter-rouge">exec</code>：与 <code class="language-plaintext highlighter-rouge">simple</code> 类似，不同之处在于， 只有在该服务的主服务进程执行完成之后，<code class="language-plaintext highlighter-rouge">systemd</code> 才会认为该服务启动完成。</li><li><code class="language-plaintext highlighter-rouge">forking</code> ：<code class="language-plaintext highlighter-rouge">exec</code> 启动的进程生成的其中一个子进程成为主进程，启动完成后，旧的主进程会退出。</li><li><code class="language-plaintext highlighter-rouge">ontshot</code>：启动下一个进程前主进程退出。</li><li><code class="language-plaintext highlighter-rouge">dbus</code>：与 <code class="language-plaintext highlighter-rouge">simple</code> 类似，不同之处在于， 该服务只有获得了 <code class="language-plaintext highlighter-rouge">BusName=</code> 指定的 <code class="language-plaintext highlighter-rouge">D-Bus</code> 名称之后，<code class="language-plaintext highlighter-rouge">systemd</code> 才会认为该服务启动完成，才会开始启动后继单元。</li><li><code class="language-plaintext highlighter-rouge">notify</code>：与 <code class="language-plaintext highlighter-rouge">exec</code> 类似，不同之处在于， 该服务将会在启动完成之后通过 <code class="language-plaintext highlighter-rouge">sd_notify(3)</code> 之类的接口发送一个通知消息</li><li><code class="language-plaintext highlighter-rouge">ldle</code>：与 <code class="language-plaintext highlighter-rouge">simple</code> 类似，不同之处在于， 服务进程将会被延迟到所有活动任务都完成之后再执行。</li></ul></li><li><code class="language-plaintext highlighter-rouge">PIDFile</code>：<code class="language-plaintext highlighter-rouge">type</code> 字段如果设置为 <code class="language-plaintext highlighter-rouge">forking</code> ，建议同时设置 <code class="language-plaintext highlighter-rouge">PIDFile</code> 选项，以帮助 <code class="language-plaintext highlighter-rouge">systemd</code> 准确可靠的定位该服务的主进程。 <code class="language-plaintext highlighter-rouge">systemd</code> 将会在父进程退出之后 立即开始启动后继单元。</li><li><code class="language-plaintext highlighter-rouge">EnvironmentFile</code>：指定当前服务的环境参数文件。该文件内部的 <code class="language-plaintext highlighter-rouge">key=value</code> 键值对，可以用 <code class="language-plaintext highlighter-rouge">$key</code> 的形式，在当前配置文件中获取。</li><li><code class="language-plaintext highlighter-rouge">ExecStart</code>：启动服务需要执行的命令</li><li><code class="language-plaintext highlighter-rouge">ExecStartpre</code>：启动服务之前执行的命令</li><li><code class="language-plaintext highlighter-rouge">ExecStartpost</code>：启动服务之后执行的命令</li><li><code class="language-plaintext highlighter-rouge">ExecStop</code>：停止服务时执行的命令</li><li><code class="language-plaintext highlighter-rouge">Restart</code>：定义启动进程时执行的命令</li><li><code class="language-plaintext highlighter-rouge">ExecReload</code>：重启服务时执行的命令</li><li><code class="language-plaintext highlighter-rouge">KillMode</code>：定义如何停止服务<ul><li><code class="language-plaintext highlighter-rouge">control-group</code>（默认值）：当前控制组里面的所有子进程，都会被杀掉</li><li><code class="language-plaintext highlighter-rouge">process</code>：只杀主进程</li><li><code class="language-plaintext highlighter-rouge">mixed</code>：主进程将收到 <code class="language-plaintext highlighter-rouge">SIGTERM</code> 信号，子进程收到 <code class="language-plaintext highlighter-rouge">SIGKILL</code> 信号</li><li><code class="language-plaintext highlighter-rouge">none</code>：没有进程会被杀掉，只是执行服务的 <code class="language-plaintext highlighter-rouge">stop</code> 命令。</li></ul></li><li><code class="language-plaintext highlighter-rouge">RestartSec</code>：表示重启服务之前，需要等待的秒数。</li></ul><h4 id="install">[install]</h4><p>定义如何安装这个配置文件，即怎样做到开机启动</p><ul><li>Alias</li><li>RequlredBy: 被那些 unit 所依赖，</li><li>WanteBy: 表示该服务所在的 Target，含义是服务组，表示一组服务。WantedBy=multi-user.target 指的是，sshd 所在的 Target 是 multi-user.target。</li></ul><h2 id="systemctl-命令">systemctl 命令</h2><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 列出正在运行的Unit</span>
systemctl list-units，可以直接使用systemctl

<span class="c"># 列出所有Unit，包括没有找到配置文件的或者启动失败的</span>
systemctl list-units <span class="nt">--all</span>

<span class="c"># 列出所有没有运行的 Unit</span>
systemctl list-units <span class="nt">--all</span> <span class="nt">--state</span><span class="o">=</span>inactive

<span class="c"># 列出所有加载失败的 Unit</span>
systemctl list-units <span class="nt">--failed</span>

<span class="c"># 列出所有正在运行的、类型为service的Unit</span>
systemctl list-units <span class="nt">--type</span><span class="o">=</span>service

<span class="c"># 显示某个 Unit 是否正在运行</span>
systemctl is-active application.service

<span class="c"># 显示某个 Unit 是否处于启动失败状态</span>
systemctl is-failed application.service

<span class="c"># 显示某个 Unit 服务是否建立了启动链接</span>
systemctl is-enabled application.service

<span class="c"># 立即启动一个服务</span>
systemctl start apache.service

<span class="c"># 立即停止一个服务</span>
systemctl stop apache.service

<span class="c"># 重启一个服务</span>
systemctl restart apache.service

<span class="c"># 重新加载一个服务的配置文件</span>
systemctl reload apache.service

<span class="c"># 重载所有修改过的配置文件</span>
systemctl daemon-reload
</code></pre></div></div><h2 id="注意事项">注意事项</h2><p>注：修改了的 unit 文件 需要重载。<code class="language-plaintext highlighter-rouge">systemctl daemon-reload</code></p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://lewinz.org" target="_blank">Lewin</a></li><li>本文链接：<a href="https://lewinz.org/2021/07/12/linux-systemctl/" target="_blank">https://lewinz.org/2021/07/12/linux-systemctl/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名</li></ul></div></article><div class="share"><div class="share-component" data-disabled='qq,weibo,qzone'></div></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2021/07/12/linux-systemctl/', clientID: '831a35f6d4f6fc049209', clientSecret: '6e80f9a3e9b50b498553e32179ad3adbd893ab7e', repo: 'blog-comments', owner: 'Lewinz', admin: ['Lewinz'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@built/assets/search_data.json?v=1627570380', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7093222719567591" data-ad-slot="5263168187" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2021 <span title="Lewin">Lewin</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/Lewinz/lewinz.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://lewinz.org/" title="首页" target="">首页</a></li><li> <a href="https://lewinz.org/categories/" title="分类" target="">分类</a></li><li> <a href="https://lewinz.org/wiki/" title="维基" target="">维基</a></li><li> <a href="https://lewinz.org/links/" title="链接" target="">链接</a></li><li> <a href="https://lewinz.org/about/" title="关于" target="">关于</a></li><li><a href="https://lewinz.org/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul><script async src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span> <span id="busuanzi_container_page_pv" style="display:none"> / 本页访问量<span id="busuanzi_value_page_pv"></span>次 / 统计始于2021-04-21 </span></div></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/share.js/dist/js/share.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-80669434-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
