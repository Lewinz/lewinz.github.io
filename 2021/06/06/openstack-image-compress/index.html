<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>openstack 制作标准镜像 &mdash; 阿嫂</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/rouge-themes@master/dist/github.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/share.js/dist/css/share.min.css"><link rel="canonical" href="https://lewinz.org/2021/06/06/openstack-image-compress/"><link rel="alternate" type="application/atom+xml" title="阿嫂" href="https://lewinz.org/feed.xml"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/favicon.ico"><meta property="og:title" content="openstack 制作标准镜像"><meta name="keywords" content="openstack,镜像"><meta name="og:keywords" content="openstack,镜像"><meta name="description" content="下载官方镜像具体的镜像地址参考： https://docs.openstack.org/image-guide/obtain-images.html"><meta name="og:description" content="下载官方镜像具体的镜像地址参考： https://docs.openstack.org/image-guide/obtain-images.html"><meta property="og:url" content="https://lewinz.org/2021/06/06/openstack-image-compress/"><meta property="og:site_name" content="阿嫂"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-06-06"> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/main.js"></script> <script data-ad-client="ca-pub-7093222719567591" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://lewinz.org/" title="阿嫂"><span class="octicon octicon-mark-github"></span> 阿嫂</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://lewinz.org/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://lewinz.org/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://lewinz.org/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://lewinz.org/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://lewinz.org/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="openstack 制作标准镜"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">openstack 制作标准镜像</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/06/06 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://lewinz.org/categories/#openstack" title="openstack">openstack</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://lewinz.org/categories/#镜像" title="镜像">镜像</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 2204 字，约 7 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" > <ins class="adsbygoogle content-header-ad" data-ad-client="ca-pub-7093222719567591" data-ad-slot="1650902835"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br /><article class="article-content markdown-body"><h2 id="下载官方镜像">下载官方镜像</h2><p>具体的镜像地址参考： <a href="https://docs.openstack.org/image-guide/obtain-images.html">https://docs.openstack.org/image-guide/obtain-images.html</a></p><h2 id="需要对镜像做的改动">需要对镜像做的改动：</h2><ul><li>配置支持密码登录</li><li>配置支持系统盘自动扩容</li><li>配置支持使用 root 登录</li><li>配置支持监控 qemu-guest-agent</li><li>配置系统日志，开启 nova console log</li></ul><h2 id="ubuntu--centos">Ubuntu | CentOS</h2><h3 id="ubuntu">Ubuntu</h3><h4 id="设置密码和-root-登录">设置密码和 root 登录</h4><p>修改 cloud-init config</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/cloud/cloud.cfg

<span class="c"># 修改内容：</span>
disable_root: <span class="nb">false</span>
<span class="c"># 新增内容：</span>
ssh_pwauth: <span class="nb">true</span>
</code></pre></div></div><p>修改 sshd_config</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/ssh/sshd_config
<span class="c"># 修改的内容：</span>
PasswordAuthentication <span class="nb">yes
</span>PermitRootLogin <span class="nb">yes</span>
</code></pre></div></div><p>重启 sshd 服务： <code class="language-plaintext highlighter-rouge">service sshd restart</code></p><h4 id="设置系统盘自动扩容">设置系统盘自动扩容</h4><p>Ubuntu 的官方 Cloud 镜像自带这个功能，所以不需要操作</p><h4 id="配置监控">配置监控</h4><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get update <span class="nt">-y</span>

<span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> qemu-guest-agent
</code></pre></div></div><h4 id="配置开启-nova-console-log">配置开启 nova console log</h4><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/default/grub

修改的内容：
GRUB_CMDLINE_LINUX_DEFAULT加上console<span class="o">=</span>tty0 <span class="nv">console</span><span class="o">=</span>ttyS0,115200
</code></pre></div></div><h3 id="centos">CentOS</h3><h4 id="cloud-init">cloud-init</h4><p>允许root远程登录</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nb">install </span>cloud-init

<span class="c"># 修改 /etc/cloud/cloud.cfg</span>
vi /etc/cloud/cloud.cfg
disable_root: 0
ssh_pwauth:   1

<span class="c"># 文件末尾添加</span>
user: root
</code></pre></div></div><h4 id="sshd_config">sshd_config</h4><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/ssh/sshd_config

<span class="c"># 修改</span>
PasswordAuthentication <span class="nb">yes</span> <span class="c"># 注意不能有多个</span>
PermitRootLogin <span class="nb">yes</span>

<span class="c"># 重启 sshd 服务</span>
service sshd restart
</code></pre></div></div><h3 id="配置支持系统盘自动扩容">配置支持系统盘自动扩容</h3><p>CentOS7官方镜像自带自动扩容，无需修改<br /> CentOS6参考<a href="https://ykfq.github.io/openstack/create-centos6-image-for-openstack">文档</a>修改</p><h3 id="qemu-guest-agent监控">qemu-guest-agent(监控)</h3><p>虚机内操作</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nb">install </span>qemu-guest-agent

vi /etc/sysconfig/qemu-ga
<span class="c"># 新增</span>
<span class="nv">FSFREEZE_HOOK_ENABLE</span><span class="o">=</span>1
<span class="c"># 注释</span>
<span class="nv">BLACKLIST_RPC</span><span class="o">=</span><span class="s2">"guest-file-open,guest-file-close,guest-file-read,guest-file-write,guest-file-seek,guest-file-flush"</span>
<span class="o">==&gt;</span>
<span class="c"># BLACKLIST_RPC="guest-file-open,guest-file-close,guest-file-read,guest-file-write,guest-file-seek,guest-file-flush"</span>
</code></pre></div></div><p>镜像文件操作<br /> 修改镜像元数据，新增 <code class="language-plaintext highlighter-rouge">hw_qemu_guest_agent=yes</code></p><h3 id="开启nova-console-log日志输出支持">开启nova console log日志输出支持</h3><h4 id="centos6">centos6</h4><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /etc/grub.conf
<span class="nv">console</span><span class="o">=</span>tty0 <span class="nv">console</span><span class="o">=</span>ttyS0,115200n8 <span class="c">#追加到kernel行末尾</span>

<span class="c">#注：/etc/grub.conf /boot/grub/menu.lst 都是指向 /boot/grub/grub.conf 的软链。</span>
</code></pre></div></div><h4 id="centos7">centos7</h4><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /etc/default/grub
删除rhgb quiet 并追加 <span class="nv">console</span><span class="o">=</span>tty0 <span class="nv">console</span><span class="o">=</span>ttyS0,115200n8
</code></pre></div></div><h4 id="重新生成grubcfg文件">重新生成grub.cfg文件</h4><p><code class="language-plaintext highlighter-rouge">grub2-mkconfig -o /boot/grub2/grub.cfg</code></p><h3 id="镜像文件格式转换与压缩">镜像文件格式转换与压缩</h3><h4 id="openstack-命令行客户端鉴权">openstack 命令行客户端鉴权</h4><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">source </span>auth.sh

<span class="c"># auth.sh 为鉴权文件，例如</span>
<span class="nb">export </span><span class="nv">OS_USERNAME</span><span class="o">=</span>openstack_username
<span class="nb">export </span><span class="nv">OS_PASSWORD</span><span class="o">=</span>openstack_password
<span class="nb">export </span><span class="nv">OS_TENANT_NAME</span><span class="o">=</span>name
<span class="nb">export </span><span class="nv">OS_AUTH_URL</span><span class="o">=</span>https://qvm-wz.qiniu.com:5000/v3
<span class="nb">export </span><span class="nv">OS_USER_DOMAIN_NAME</span><span class="o">=</span>Default
<span class="nb">export </span><span class="nv">OS_PROJECT_DOMAIN_NAME</span><span class="o">=</span>Default
<span class="nb">export </span><span class="nv">OS_IDENTITY_API_VERSION</span><span class="o">=</span>3
<span class="nb">export </span><span class="nv">OS_PROJECT_ID</span><span class="o">=</span>project_id
</code></pre></div></div><h4 id="镜像格式转换">镜像格式转换</h4><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># -f 转换前格式</span>
<span class="c"># -O 转换后格式</span>
qemu-img convert <span class="nt">-f</span> qcow2 <span class="nt">-O</span> raw test.qcow2 test.raw
</code></pre></div></div><h4 id="压缩镜像文件">压缩镜像文件</h4><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># -- -18.5G 在原有镜像文件基础上压缩 18.5G</span>
<span class="c"># CentOS镜像可能会出现压缩后转换格式size变很小，解决办法是压缩时减少压缩大小</span>
qemu-img resize test.raw <span class="nt">--</span> <span class="nt">-18</span>.5G
</code></pre></div></div><h4 id="重新上传镜像文件">重新上传镜像文件</h4><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>glance image-create <span class="nt">--name</span> Ubuntu <span class="nt">--disk-format</span> raw <span class="nt">--container-format</span> bare <span class="nt">--property</span> <span class="nv">os_type</span><span class="o">=</span><span class="s2">"linux"</span> <span class="nt">--property</span> <span class="nv">os_distro</span><span class="o">=</span><span class="s2">"UbuntuServer16.04-64"</span> <span class="nt">--file</span> test.qcow2
</code></pre></div></div><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://lewinz.org" target="_blank">Lewin</a></li><li>本文链接：<a href="https://lewinz.org/2021/06/06/openstack-image-compress/" target="_blank">https://lewinz.org/2021/06/06/openstack-image-compress/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名</li></ul></div></article><div class="share"><div class="share-component" data-disabled='qq,weibo,qzone'></div></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2021/06/06/openstack-image-compress/', clientID: '831a35f6d4f6fc049209', clientSecret: '6e80f9a3e9b50b498553e32179ad3adbd893ab7e', repo: 'blog-comments', owner: 'Lewinz', admin: ['Lewinz'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@built/assets/search_data.json?v=1625139064', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7093222719567591" data-ad-slot="5263168187" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2021 <span title="Lewin">Lewin</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/Lewinz/lewinz.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://lewinz.org/" title="首页" target="">首页</a></li><li> <a href="https://lewinz.org/categories/" title="分类" target="">分类</a></li><li> <a href="https://lewinz.org/wiki/" title="维基" target="">维基</a></li><li> <a href="https://lewinz.org/links/" title="链接" target="">链接</a></li><li> <a href="https://lewinz.org/about/" title="关于" target="">关于</a></li><li><a href="https://lewinz.org/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul><script async src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span> <span id="busuanzi_container_page_pv" style="display:none"> / 本页访问量<span id="busuanzi_value_page_pv"></span>次 / 统计始于2021-04-21 </span></div></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/share.js/dist/js/share.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-80669434-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
