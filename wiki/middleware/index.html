<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>中间件部署文档 &mdash; 阿嫂</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/rouge-themes@master/dist/gruvbox.css"><link rel="canonical" href="https://lewinz.org/wiki/middleware/"><link rel="alternate" type="application/atom+xml" title="阿嫂" href="https://lewinz.org/feed.xml"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/favicon.ico"><meta property="og:title" content="中间件部署文档"><meta name="keywords" content="中间件, 部署"><meta name="og:keywords" content="中间件, 部署"><meta name="description" content="JDK"><meta name="og:description" content="JDK"><meta property="og:url" content="https://lewinz.org/wiki/middleware/"><meta property="og:site_name" content="阿嫂"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-05-31"> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/main.js"></script> <script data-ad-client="ca-pub-7093222719567591" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://lewinz.org/" title="阿嫂"><span class="octicon octicon-mark-github"></span> 阿嫂</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://lewinz.org/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://lewinz.org/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://lewinz.org/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://lewinz.org/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://lewinz.org/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="中间件部署文档"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">中间件部署文档</h1></div></div><div class="column one-fourth mobile-hidden"></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" > <ins class="adsbygoogle content-header-ad" data-ad-client="ca-pub-7093222719567591" data-ad-slot="1650902835"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br /><article class="article-content markdown-body"><h1 id="jdk"><strong>JDK</strong></h1><h3 id="rpm方式">rpm方式</h3><p>上传准备好的离线安装包到服务器 安装<br /> <code class="language-plaintext highlighter-rouge">rpm -ivh jdk-8u181-linux-x64.rpm</code></p><h3 id="压缩包安装">压缩包安装</h3><p>上传准备好的压缩包到服务器</p><p>切换到安装目录<br /> <code class="language-plaintext highlighter-rouge">tar -zvxf /mnt/package/jdk-8u181-linux-x64.tar.gz</code></p><p>修改环境变量<br /> <code class="language-plaintext highlighter-rouge">vim /etc/profile</code></p><p>添加以下内容</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export JAVA_HOME=/mnt/app/jdk
export JRE_HOME=${JAVA_HOME}/jre
export CLASSPATH=.:${JAVA_HOME}/lib:${JRE_HOME}/lib:$CLASSPATH
export JAVA_PATH=${JAVA_HOME}/bin:${JRE_HOME}/bin
export PATH=$PATH:${JAVA_PATH}
</code></pre></div></div><p>重新生效配置<br /> <code class="language-plaintext highlighter-rouge">source /etc/profile</code></p><h3 id="检查">检查</h3><p>输入<code class="language-plaintext highlighter-rouge">java -version</code>出现信息则说明安装成功</p><h1 id="postgresql"><strong>Postgresql</strong></h1><h3 id="在线安装">在线安装</h3><ol><li><p>安装RPM<br /> <code class="language-plaintext highlighter-rouge">yum install</code></p></li><li><p>安装客户端(若安装服务器，则不需要)<br /> <code class="language-plaintext highlighter-rouge">yum install postgresql12</code></p></li><li><p>安装服务端<br /> <code class="language-plaintext highlighter-rouge">yum install postgresql12-server</code></p></li></ol><h3 id="离线安装">离线安装</h3><p><strong>rpm包</strong></p><p>准备好如下rpm安装包</p><blockquote><p>libicu-50.2-4.el7_7.x86_64.rpm<br /> libxslt-1.1.28-5.el7.x86_64.rpm<br /> postgresql12-libs-12.4-1PGDG.rhel7.x86_64.rpm<br /> postgresql12-12.4-1PGDG.rhel7.x86_64.rpm<br /> postgresql12-server-12.4-1PGDG.rhel7.x86_64.rpm<br /> postgresql12-contrib-12.4-1PGDG.rhel7.x86_64.rpm</p></blockquote><p>**安装rpm包<按顺序执行>**</按顺序执行></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpm -ivh libicu-50.2-4.el7_7.x86_64.rpm --force --nodeps
 
rpm -ivh libxslt-1.1.28-5.el7.x86_64.rpm --force --nodeps
 
rpm -ivh postgresql12-libs-12.4-1PGDG.rhel7.x86_64.rpm --force --nodeps
 
rpm -ivh postgresql12-12.4-1PGDG.rhel7.x86_64.rpm --force --nodeps
 
rpm -ivh postgresql12-server-12.4-1PGDG.rhel7.x86_64.rpm --force --nodeps
 
rpm -ivh postgresql12-contrib-12.4-1PGDG.rhel7.x86_64.rpm --force --nodeps
</code></pre></div></div><p><strong>配置步骤</strong></p><p>始化数据库并启用自动启动 （可选）<br /> 初始化数据库<br /> <code class="language-plaintext highlighter-rouge">/usr/pgsql-12/bin/postgresql-12-setup initdb</code></p><p>设置开机启动pg服务<br /> <code class="language-plaintext highlighter-rouge">systemctl enable postgresql-12</code></p><p>启动pg服务<br /> <code class="language-plaintext highlighter-rouge">systemctl start postgresql-12</code></p><p>修改PostgreSQL远程连接配置<br /> <code class="language-plaintext highlighter-rouge">vim /var/lib/pgsql/12/data/pg_hba.conf</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local   all             all                                     peer
host    all             all             127.0.0.1/32            trust
host    all             all             all                     md5
host    replication     all             127.0.0.1/32            trust
host    replication     all             all                     md5
</code></pre></div></div><p>修改配置</p><p><code class="language-plaintext highlighter-rouge">vim /var/lib/pgsql/12/data/postgresql.conf</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 新增以下配置
# 放开远程连接ip限制
listen_addresses = '*'
# 配置pg_stat_statements
shared_preload_libraries = 'pg_stat_statements'
track_activity_query_size = 2048
# 配置流复制模式，允许debezium cdc组件实时抓取 
wal_level = logical
max_wal_senders = 10
max_replication_slots = 10
pg_stat_statements.track = all

# 修改以下配置
max_wal_size = 1GB
min_wal_size = 100MB
</code></pre></div></div><p>重启服务<br /> <code class="language-plaintext highlighter-rouge">systemctl restart postgresql-12</code></p><p>修改postgres账号密码<br /> 使用postgres登入数据库<br /> <code class="language-plaintext highlighter-rouge">psql -h 127.0.0.1 -d postgres -U postgres</code></p><p>修改postgres密码<br /> <code class="language-plaintext highlighter-rouge">alter user postgres with password 'postgres';</code></p><p>加载pg_stat_statements<br /> <code class="language-plaintext highlighter-rouge">CREATE EXTENSION pg_stat_statements;</code></p><p><strong>挂载外部数据盘 ps: mnt为任意挂载盘</strong><br /> 停止pgsql <br /> <code class="language-plaintext highlighter-rouge">systemctl stop postgresql-12</code></p><p>编辑<code class="language-plaintext highlighter-rouge">vim /usr/lib/systemd/system/postgresql-12.service</code></p><p>修改文件中PGDATA路径配置为外部数据盘相应文件夹地址<br /> 配置由<code class="language-plaintext highlighter-rouge">Environment=PGDATA=/var/lib/pgsql/12/data/</code><br /> 变为<code class="language-plaintext highlighter-rouge">Environment=PGDATA=/mnt/pg/data/</code></p><p>将文件夹复制到外部数据盘<br /> <code class="language-plaintext highlighter-rouge">mv /var/lib/pgsql/12/data/ /mnt/pg/data/</code></p><p>将数据目录文件夹所有者改为postgres用户, postgres用户组<br /> <code class="language-plaintext highlighter-rouge">chown postgres:postgres /mnt/pg/data/ -R</code></p><p>访问权限改为 750或700<br /> <code class="language-plaintext highlighter-rouge">chmod 750 -R /mnt/pg/data/</code><br /> 执行 <code class="language-plaintext highlighter-rouge">systemctl daemon-reload</code><br /> 以后修改配置文件就在/mnt/pg/data下面修改</p><p>重启服务<br /> <code class="language-plaintext highlighter-rouge">systemctl restart postgresql-12</code></p><h3 id="postgresql主从">Postgresql主从</h3><p>安装PG从库<br /> 按照前面的安装操作，在另一台服务器安装从库pg。 <br /> <strong>！！！从库在部署时不能初始化数据库，否则会导致主从库序列号不一致。</strong></p><p><strong>配置步骤</strong></p><p>准备流复制角色 ps: 密码可更改<br /> 在主库中创建进行流复制的角色</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE ROLE repuser WITH
  LOGIN
  REPLICATION
  CONNECTION LIMIT 5
  PASSWORD '1qazXSW@3edc';
</code></pre></div></div><p>修改主库配置<br /> 打开主库配置文件夹<br /> <code class="language-plaintext highlighter-rouge">cd /mnt/pg/data</code></p><p><code class="language-plaintext highlighter-rouge">vim pg_hba.conf</code> 在最后一行添加</p><p><code class="language-plaintext highlighter-rouge">host replication repuser 从库ip/32 md5</code></p><p><code class="language-plaintext highlighter-rouge">vim postgresql.conf</code> 修改以下变量</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>archive_mode = on
archive_command = '/bin/date'
max_wal_senders = 10
wal_keep_segments = 16
synchronous_standby_names = '*'
</code></pre></div></div><p>重启主库 使配置生效</p><p>从库配置<br /> 使用以下命令 在两边服务器中检查， 主从服务器连通性</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ping ip
    telnet ip 5432
</code></pre></div></div><p>确认无误后，在从库服务器执行以下命令，备份主库数据</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /mnt/pg/     打开从库pg的数据文件夹处  
pg_basebackup -R -D /mnt/pg/backup -Fp -Xs -v -P -h 主库ip -p 5432 -U repuser  
</code></pre></div></div><p>将原数据文件夹备份 再将backup改名为data<br /> 更改data文件夹的用户组，权限</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chown postgres:postgres data -R
chmod 750 -R data
</code></pre></div></div><p>检查 postgresql.auto.conf 文件里是否包含如下内容：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>primary_conninfo = 'user=repuser password=''1qazXSW@3edc'' host=主库IP port=5432 sslmode=prefer sslcompression=0 gssencmode=prefer krbsrvname=postgres target_session_attrs=any'
</code></pre></div></div><p>重启从库PG<br /> 检查主从是否成功</p><p>在主库中查询流复制信息<br /> <code class="language-plaintext highlighter-rouge">select * from pg_stat_replication;</code></p><p>在主库中添加或修改数据，在从库中查看。</p><h1 id="mysql">MySql</h1><h3 id="单节点安装">单节点安装</h3><p>检查插件</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 会与mysql冲突，如果预装了，先卸载
rpm -qa|grep mariadb
rpm -e --nodeps mariadb-xxxxxxxx.x86_64

# mysql安装依赖插件，如果没有，先安装
rpm -qa|grep libaio
yum install libaio
</code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 安装mysql
rpm -ivh mysql-community-common-5.7.22-1.el7.x86_64.rpm
rpm -ivh mysql-community-libs-5.7.22-1.el7.x86_64.rpm
rpm -ivh mysql-community-client-5.7.22-1.el7.x86_64.rpm
rpm -ivh mysql-community-server-5.7.22-1.el7.x86_64.rpm
</code></pre></div></div><p>安装如果报错<code class="language-plaintext highlighter-rouge">perl(Getopt::Long) is needed</code><br /> 执行<code class="language-plaintext highlighter-rouge">yum install perl</code></p><p>如果报错<code class="language-plaintext highlighter-rouge">warning: mysql-community-server-5.7.22-1.el7.x86_64.rpm: Header V3 DSA/SHA1 Signature, key ID 5072e1f5: NOKEY</code><br /> 解决办法：<code class="language-plaintext highlighter-rouge">在rpm命令后加上 --force --nodeps</code></p><p>初始化数据库，自动创建data文件目录<br /> <code class="language-plaintext highlighter-rouge">mysqld --initialize-insecure --user=mysql</code></p><p>将<code class="language-plaintext highlighter-rouge">/var/lib/mysql</code>文件所有用户修改为mysql <code class="language-plaintext highlighter-rouge">chown mysql:mysql /var/lib/mysql -R</code></p><p>修改mysql配置<br /> <code class="language-plaintext highlighter-rouge">vi /etc/my.cnf</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user=mysql
skip-name-resolve
max_connections=500
wait_timeout=31536000
interactive_timeout=31536000
</code></pre></div></div><p>启动mysql<br /> <code class="language-plaintext highlighter-rouge">systemctl start mysqld.service</code></p><p>登陆mysql修改密码</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql -u root
 
update mysql.user set authentication_string = password('123456') where user = 'root' and host = 'localhost';
 
grant all privileges on *.* to 'root'@'%' identified by '123456' with grant option;
 
flush privileges;
</code></pre></div></div><p>退出mysql后，设置开机自启，重启mysql</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl stop mysqld.service
systemctl enable mysqld.service
systemctl list-unit-files | grep mysqld
systemctl start mysqld.service
</code></pre></div></div><h3 id="主从模式安装">主从模式安装</h3><p><strong>主节点修改</strong></p><p><code class="language-plaintext highlighter-rouge">vim /etc/my.cnf</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## 设置server_id，一般设置为IP,注意要唯一
server-id=125107
## 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）
binlog-ignore-db=mysql
binlog-ignore-db=sys
binlog-ignore-db=information_schema
binlog-ignore-db=performance_schem
## 开启二进制日志功能，可以随便取，最好有含义（关键就是这里了）
log-bin=mysql-bin
## 为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存
binlog_cache_size=16M
## 主从复制的格式（mixed,statement,row，默认格式是statement）
binlog_format=mixed
## 二进制日志自动删除/过期的天数。默认值为0，表示不自动删除。
expire_logs_days=30
## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。
## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致
slave_skip_errors=1062
## 控制binlog的写入频率。每执行多少次事务写入一次
## 这个参数性能消耗很大，但可减小MySQL崩溃造成的损失，为0表示不控制
sync_binlog = 1
innodb_flush_log_at_trx_commit = 1
</code></pre></div></div><p>重启主节点服务</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart mysqld.service
</code></pre></div></div><p>创建同步用户</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 创建给从节点使用
CREATE USER 'slave'@'%' IDENTIFIED BY 'a123456';

GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'slave'@'%';
</code></pre></div></div><p><strong>从节点修改</strong></p><p><code class="language-plaintext highlighter-rouge">vim /etc/my.cnf</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## 设置server_id，一般设置为IP,注意要唯一
server-id=125111
## 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）
binlog-ignore-db=mysql
binlog-ignore-db=sys
binlog-ignore-db=information_schema
binlog-ignore-db=performance_schem
## 开启二进制日志功能，以备Slave作为其它Slave的Master时使用
#log-bin=mysql-slave1-bin
## 为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存
binlog_cache_size=16M
## 主从复制的格式（mixed,statement,row，默认格式是statement）
binlog_format=mixed
## 二进制日志自动删除/过期的天数。默认值为0，表示不自动删除。
expire_logs_days=30
## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。
## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致
slave_skip_errors=1062
## relay_log配置中继日志
relay_log=mysql-relay-bin
## log_slave_updates表示slave将复制事件写进自己的二进制日志
## 主要为了作为其他的master
#log_slave_updates=ON
## 防止改变数据(除了特殊的线程)
#read_only=1(为了使备机随时转正，所以这里允许写)
## MySQL主从复制的时候，当Master和Slave之间的网络中断，但是Master和Slave无法察觉的情况下（比如防火墙或者路由问题）。Slave会等待slave_net_timeout设置的秒数后，才能认为网络出现故障，然后才会重连并且追赶这段时间主库的数据,默认60
slave-net-timeout = 20                    
## 如果启用，此变量将在服务器启动后立即启用自动中继日志恢复。
relay_log_recovery = ON
## 该变量确定从站在中继日志中的位置是写入FILE还是写入表
relay_log_info_repository = TABLE
</code></pre></div></div><p>重启从节点服务</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart mysqld.service
</code></pre></div></div><p>登录从节点mysql</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 命令信息需要修改，在主节点执行命令 show master status\G; 获取
change master to master_host='47.117.136.250', master_user='slave', master_password='a123456', master_port=3306, master_log_file='mysql-bin.000002', master_log_pos=154, master_connect_retry=30,master_heartbeat_period=10;
</code></pre></div></div><p>开始主从复制</p><p><code class="language-plaintext highlighter-rouge">start slave;</code></p><p>查看主从同步状态<br /> <code class="language-plaintext highlighter-rouge">show slave status\G;</code></p><p>Slave_IO_Running/Slave_SQL_Running 两个属性都为YES即为复制成功</p><p>若主从复制信息设置错误，可通过下列命令重置信息</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 停止已经启动的绑定
stop slave;
# 重置绑定
reset master;
# 启动复制
start slave;
</code></pre></div></div><p><strong>常见错误：</strong></p><p>查看错误日志 <code class="language-plaintext highlighter-rouge">tail -f -n 1000 /var/log/mysqld.log</code></p><p>errNum: <br /> <strong>1236</strong> 复制信息有误，重新设置。</p><p>errNum: <br /> <strong>1593</strong> 在mysql中使用 <code class="language-plaintext highlighter-rouge">show variables like '%server_%';</code> 查看 server_id/server_uuid 是否配置生效，server_id配置在my.cnf中，server_uuid在auto.cnf中。</p><h1 id="nginx">Nginx</h1><h3 id="安装相关依赖">安装相关依赖</h3><p><code class="language-plaintext highlighter-rouge">yum -y install gcc gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel gd gd-devel</code></p><h3 id="安装nginx">安装nginx</h3><p>解压ngnix安装包 <code class="language-plaintext highlighter-rouge">tar -zxvf nginx-1.17.3.tar.gz</code></p><p>进入解压缩目录,编译监控插件<br /> <code class="language-plaintext highlighter-rouge">./configure --add-module=/mnt/nginx/nginx-module-vts</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make
make install
</code></pre></div></div><p>启动<br /> <code class="language-plaintext highlighter-rouge">cd /usr/local/nginx/sbin</code><br /> ./nginx</p><h3 id="配置">配置</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
    listen 8000;
    server_name info;
    client_max_body_size 20M;
    root /data/info/99-admin-web/info-web;
 
    include /etc/nginx/default.d/*.conf;
 
    location /{
        root /data/info/99-admin-web;
        index index.html index.htm;
    }
 
    location /info-api/ {
        proxy_pass http://gateway地址:8080/;
    }
    #添加监控接口/status/：
    location /status {             
        vhost_traffic_status_display;             
        vhost_traffic_status_display_format html;         
    }
}
</code></pre></div></div><h1 id="nacos">Nacos</h1><h3 id="单机部署">单机部署</h3><p><strong>通过源码或者发行包获取</strong></p><p>从 Github 上下载源码方式</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/alibaba/nacos.git
cd nacos/
mvn -Prelease-nacos clean install -U  
ls -al distribution/target/
cd distribution/target/nacos-server-$version/nacos/bin
</code></pre></div></div><p>下载编译后压缩包方式</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/alibaba/nacos/releases
unzip nacos-server-$version.zip 或者 tar -xvf nacos-server-$version.tar.gz
cd nacos/bin
</code></pre></div></div><p><strong>单机启动</strong> <code class="language-plaintext highlighter-rouge">sh startup.sh -m standalone</code></p><p>关闭服务 <code class="language-plaintext highlighter-rouge">sh shutdown.sh</code></p><h3 id="集群部署">集群部署</h3><p>安装数据库，版本要求：5.6.5+</p><p>初始化mysql数据库，数据库初始化文件：nacos-mysql.sql</p><p>修改conf/application.properties文件，添加mysql数据源的url、用户名和密码。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spring.datasource.platform=mysql
db.num=1
db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true
db.user=user_name
db.password=pwd
</code></pre></div></div><p>修改conf目录下cluster.conf文件</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xxx.xxx.xxx.16:8848
xxx.xxx.xxx.17:8848
xxx.xxx.xxx.18:8848
</code></pre></div></div><p>配置mysql数据库</p><p>无参模式启动startup.sh脚本<br /> <code class="language-plaintext highlighter-rouge">sh startup.sh</code></p><h1 id="kafka">Kafka</h1><h3 id="zookeeper单节点安装可使用kafka自带">zookeeper单节点安装（可使用kafka自带）</h3><p><strong>解压zookeeper压缩包（必须是带”bin”的压缩包，否则启动会报错）</strong></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /mnt/zookeeper/
tar -zxvf apache-zookeeper-3.6.2-bin.tar.gz
</code></pre></div></div><p><strong>修改配置文件</strong></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /mnt/zookeeper/apache-zookeeper-3.6.2-bin/conf
cp zoo_sample.cfg zoo.cfg
vi zoo.cfg
</code></pre></div></div><p><strong>配置数据路径和日志路径</strong></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dataDir=/mnt/data/zookeeper
dataLogDir=/mnt/logs/zookeeper

# 自动清理日志&lt;非必须&gt; 3.4之后版本可配置
autopurge.snapRetainCount=3
autopurge.purgeInterval=1
</code></pre></div></div><p><strong>配置环境变量</strong></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export ZOOKEEPER_INSTALL=/mnt/zookeeper/apache-zookeeper-3.6.2-bin/
export PATH=$PATH:$ZOOKEEPER_INSTALL/bin
</code></pre></div></div><p><strong>启动zookeeper服务</strong></p><p><code class="language-plaintext highlighter-rouge">/mnt/zookeeper/apache-zookeeper-3.6.2-bin/bin/zkServer.sh start</code></p><p><strong>启动成功</strong></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ZooKeeper JMX enabled by default
Using config: /usr/local/zookeeper-3.4.13/bin/../conf/zoo.cfg
Starting zookeeper ... STARTED
</code></pre></div></div><h3 id="zookeeper集群安装">zookeeper集群安装</h3><p>多台服务器zookeeper单节点安装完毕之后</p><p>在zoo.cfg配置的data目录下新增myid文件 ` echo 1 &gt; /mnt/software/zookeeper/data/myid`</p><p><code class="language-plaintext highlighter-rouge">vim /mnt/software/zookeeper/conf/zoo.cfg</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ip:port:port&lt;port:port为选举leader使用，默认2888:3888，如果是一台服务器部署集群，使用多个不同端口即可&gt;
server.1=xx.xx.xx.xx:2888:3888
server.2=xx.xx.xx.xx:2888:3888
server.3=xx.xx.xx.xx:2888:2888
</code></pre></div></div><p>启动服务。</p><h3 id="kafka单节点部署">kafka单节点部署</h3><p>解压kafka压缩包</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /mnt/tools

tar -zxvf kafka_2.13-2.6.0.tgz
mv kafka_2.13-2.6.0 /mnt/software/kafka

cd /mnt/software/kafka
mkdir zookeeper
mkdir log
mkdir log/zookeeper
mkdir log/kafka
</code></pre></div></div><p>修改zookeeper配置</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim config/zookeeper.properties
dataDir= /mnt/software/kafka/zookeeper
</code></pre></div></div><p>修改kafka配置</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim config/server.properties
#修改这几项
log.dirs=/mnt/software/kafka/log/kafka  #日志存放路径
listeners=PLAINTEXT://10.17.64.110:9092 #IP填本机地址 外网/内网可访问地址
zookeeper.connect=10.17.64.110:2181  #IP填zookeeper安装地址
</code></pre></div></div><p>先启动zookeeper</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh bin/zookeeper-server-start.sh -daemon  config/zookeeper.properties
sh bin/kafka-server-start.sh -daemon config/server.properties
</code></pre></div></div><p>创建 Topic</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic test
</code></pre></div></div><p>查看 topic 列表</p><p><code class="language-plaintext highlighter-rouge">bin/kafka-topics.sh --list --zookeeper localhost:2181</code></p><p>查看描述 topics 信息</p><p><code class="language-plaintext highlighter-rouge">bin/kafka-topics.sh --describe --zookeeper localhost:2181 --topic test</code></p><p>启动生产者</p><p><code class="language-plaintext highlighter-rouge">bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test</code></p><p>启动消费者</p><p><code class="language-plaintext highlighter-rouge"> bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --from-beginning --from-beginning 表示从起始位读取 </code></p><p>启动先zookeeper 停止先kafka</p><h3 id="kafka集群部署">kafka集群部署</h3><p>复制kafka文件夹到其它服务器</p><p>在/mnt/kafka/zookeeper下添加myid文件，写入服务broker.id属性值<br /> 例如 echo 0 &gt; myid</p><p>修改zookeeper配置文件<br /> <code class="language-plaintext highlighter-rouge">config/zookeeper.properties</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#注释掉
#maxClientCnxns=0

#设置连接参数，添加如下配置
tickTime=2000　　　　#为zk的基本时间单元，毫秒
initLimit=10　　　　 #Leader-Follower初始通信时限 tickTime*10
syncLimit=5　　　　　#Leader-Follower同步通信时限 tickTime*5
 
#设置broker Id的服务地址 id值与服务器IP对应
server.0=10.17.64.110:2888:3888
server.1=10.17.64.111:2888:3888
server.2=10.17.64.112:2888:3888
</code></pre></div></div><p>修改kafka配置文件 config/server.properties</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>broker.id=0  # kafka实例的唯一标识，用整数表示，使用不同的整数值将集群中的kafka实例区分即可

# topic 在当前broker上的分片个数，与broker保持一致
num.partitions=3
zookeeper.connect=node1:2181,node2:2181,node3:2181
 
1. broker.id：同一个集群中，每台机器均不能一样
2. zookeeper.connect：有几台zookeeper服务器，设置为几台台，必须全部加进去
3. listeners：在配置集群的时候，必须设置，不然以后的操作会报找不到leader的错误
</code></pre></div></div><p>配置完成后先启动zookeeper 保证服务都启动后在启动kafka</p><h1 id="es集群搭建">ES集群搭建</h1><p>解压安装包</p><p>安装rpm<br /> <code class="language-plaintext highlighter-rouge">rpm -ivh elasticsearch-7.8.0-x86_64.rpm</code></p><p>更新es配置<br /> <code class="language-plaintext highlighter-rouge">vim /etc/elasticsearch/elasticsearch.yml</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Use a descriptive name for your cluster:
#
cluster.name: elasticsearch
///节点名称
# Use a descriptive name for the node:
#
node.name: 'es-node1'
///数据以及日志存放路径
# Path to directory where to store the data (separate multiple locations by comma):
#
path.data: /data/elasticsearch/data
#
# Path to log files:
#
path.logs: /data/elasticsearch/logs
///本机ip以及端口
# Set the bind address to a specific IP (IPv4 or IPv6):
#
network.host: 10.0.209.47
network.bind_host: 10.0.209.47
network.publish_host: 10.0.209.47
#
# Set a custom port for HTTP:
#
http.port: 9200
///集群ip配置以及主节点数（计算方式：total number of master-eligible nodes / 2 + 1）
# Pass an initial list of hosts to perform discovery when new node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
discovery.zen.ping.unicast.hosts: ["10.0.209.47", "10.0.209.44","10.0.209.43"]
#
# Prevent the "split brain" by configuring the majority of nodes (total number of master-eligible nodes / 2 + 1):
#
discovery.zen.minimum_master_nodes: 2
</code></pre></div></div><p>设置jvm参数<br /> <code class="language-plaintext highlighter-rouge">vim etc/elasticsearch/jvm.options （内存允许 设置31g）</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-Xms31g
-Xmx31g
</code></pre></div></div><p>配置密码 （公网环境需要设置，客户服务器视情况而定 内网访问可不需要密码）</p><p>执行以下命令输入ElasticSearch的密码</p><p><code class="language-plaintext highlighter-rouge">/usr/share/elasticsearch/bin/elasticsearch-setup-passwords interactive</code></p><p>配置开机启动</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl enable elasticsearch.service
systemctl start elasticsearch
systemctl status elasticsearch
</code></pre></div></div><h1 id="redis">Redis</h1><h3 id="单机搭建">单机搭建</h3><p>解压</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tar –zxvf redis-5.0.5.tar.gz

cd /mnt/software/redis/

&lt;sudo&gt; make MALLOC=libc &amp;&amp; make install
</code></pre></div></div><p>如果在此步报错<br /> cc: 错误：../deps/hiredis/libhiredis.a：没有那个文件或目录<br /> cc: 错误：../deps/lua/src/liblua.a：没有那个文件或目录</p><p>切换至deps/执行</p><p><code class="language-plaintext highlighter-rouge">&lt;sudo&gt; make lua hiredis linenoise</code></p><p>再执行<code class="language-plaintext highlighter-rouge">&lt;sudo&gt; make MALLOC=libc &amp;&amp; make install</code>即可</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd src
./redis-server
</code></pre></div></div><h3 id="redis配置成服务">Redis配置成服务</h3><p>修改配置文件redis.conf<br /> <code class="language-plaintext highlighter-rouge">vim /mnt/software/redis/redis.conf</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 三个参数都是修改
bind 0.0.0.0
logfile /mnt/software/redis/logs/redis.log
dir /mnt/software/redis/data
</code></pre></div></div><p>将配置文件拷贝到/etc/init.d目录下</p><p><code class="language-plaintext highlighter-rouge">cp /mnt/software/redis/redis.conf /etc/redis/redis.conf</code></p><p>将redis启动脚本复制到/etc/init.d目录下</p><p><code class="language-plaintext highlighter-rouge">cp /mnt/software/redis/utils/redis_init_script /etc/init.d/redis</code></p><p>修改启动脚本</p><p><code class="language-plaintext highlighter-rouge">vim /etc/init.d/redis</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 修改参数，文件名为刚刚复制到此目录的 conf 文件
CONF="/etc/redis/6379.conf"
</code></pre></div></div><p>redis文件添加到 systemctl</p><p><code class="language-plaintext highlighter-rouge">systemctl enable redis</code></p><p>重启Redis</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;sudo&gt; systemctl stop redis
&lt;sudo&gt; systemctl start redis
</code></pre></div></div><h3 id="redis配置主从复制">Redis配置主从复制</h3><p>1）各结点启动redis 服务</p><p><code class="language-plaintext highlighter-rouge">sudo systemctl start redis</code></p><p>2）登陆从结点，查看主从复制情况</p><p><code class="language-plaintext highlighter-rouge">/data/redis/redis-5.0.5/src/redis-cli info Replication</code></p><p>3）设置开机自启</p><p><code class="language-plaintext highlighter-rouge">$ sudo /sbin/chkconfig redis on</code></p><p>从redis149上配置文件6379.conf添加</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>slaveof 10.16.212.224 6379
slave-read-only yes
</code></pre></div></div><p>4）验证</p><p>执行redis-cli 连接到redis-service</p><p>执行info Replication命令查看状态</p><p>看到从节点上有</p><p>master_host: 10.16.212.224以及slave_read_only:1字样即为配置成功</p><h3 id="集群部署-1">集群部署</h3><p>暂时先参考此文档：https://www.jianshu.com/p/8045b92fafb2</p><h1 id="监控系统">监控系统</h1><h3 id="prometheus">Prometheus</h3><p>节点规划</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip
port
x.x.x.x
9090
</code></pre></div></div><p>解压缩事先下载好的Prometheus二进制包到/user/local/prometheus目录下</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tar -zxvf prometheus-2.14.0.linux-amd64.tar.gz -C /opt/software/
cd /opt/software/
mv prometheus-2.14.0.linux-amd64/ prometheus
</code></pre></div></div><p>验证版本信息，确认安装包没有问题</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd prometheus/
./prometheus –version
</code></pre></div></div><p>备份配置文件，后续修改prometheus.yml配置文件来收集监控信息<br /> <code class="language-plaintext highlighter-rouge">cp prometheus.yml prometheus.yml-bak</code></p><p>将Prometheus配置为系统服务<br /> <code class="language-plaintext highlighter-rouge">vim /etc/systemd/system/prometheus.service</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Ps: ExecStart参数为现在服务安装路径 storage.tsdb.path为数据存储路径 可修改
[Unit]
Description=Prometheus Server
Documentation=https://prometheus.io/docs/introduction/overview/
After=network-online.target
[Service]
User=root
Restart=on-failure
ExecStart=/opt/software/prometheus/prometheus \
 --config.file=/opt/software/prometheus/prometheus.yml \
 --storage.tsdb.path=/opt/software/prometheus/data
[Install]
WantedBy=multi-user.target
</code></pre></div></div><p>重新加载systemd系统</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload 
systemctl start prometheus 
systemctl enable prometheus.service
</code></pre></div></div><p>检查服务状态<br /> <code class="language-plaintext highlighter-rouge">systemctl status prometheus</code></p><p>浏览器中打开 http://x.x.x.x:9090/若能看到内容，安装成功</p><h3 id="grafana安装">Grafana安装</h3><p>节点规划</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip
port
x.x.x.x
3000
</code></pre></div></div><p>执行rpm安装事前下载好的rpm安装包<br /> <code class="language-plaintext highlighter-rouge">rpm -Uvh grafana-6.4.4-1.x86_64.rpm</code></p><p>重新加载systemd系统</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload 
systemctl start grafana-server.service
systemctl enable grafana-server.service
</code></pre></div></div><p>检查服务状态<br /> <code class="language-plaintext highlighter-rouge">systemctl status grafana-server.service</code></p><p>浏览器中打开 http://xxx.xxx.xxx.xxx:3000/若能看到登录页面，安装成功</p><h3 id="kafka-exporter--ps适用于未加权限的kafka">Kafka-exporter ps:适用于未加权限的kafka</h3><p>节点规划</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip
port
x.x.x.x
9308
</code></pre></div></div><p>解压缩事先下载好的kafka-exporter二进制包到/user/local/kafka-exporter目录下</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tar -zxvf kafka_exporter-1.2.0.linux-amd64.tar.gz -C /opt/software/
cd /opt/software/
mv kafka_exporter-1.2.0.linux-amd64/ kafka-exporter
</code></pre></div></div><p>编辑host文件，适配大数据平台<br /> <code class="language-plaintext highlighter-rouge">vim/etc/hosts</code></p><p>若kafka集群有域名地址<br /> 添加如下内容<br /> <code class="language-plaintext highlighter-rouge">x.x.x.x cdh-xxx</code></p><p>把kafka-exporter配置为系统服务<br /> <code class="language-plaintext highlighter-rouge">vim /etc/systemd/system/kafka-exporter.service</code></p><p>Ps: ExecStart参数为现在服务安装路径 kafka.server参数为要监控的kafka地址，可多个。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> [Unit]
Description=Kafka exporter
After=network-online.target
[Service]
User=root
Restart=on-failure
ExecStart=/opt/software/kafka-exporter/kafka_exporter \
--kafka.server=cdh-xxx:9092
[Install]
WantedBy=multi-user.target
</code></pre></div></div><p>重新加载systemd系统</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload 
systemctl start kafka-exporter 
systemctl enable kafka-exporter.service
</code></pre></div></div><p>检查服务状态<br /> <code class="language-plaintext highlighter-rouge">systemctl status kafka-exporter</code></p><h3 id="kafka-minion-ps适用于加权限的kafka">Kafka-minion ps:适用于加权限的kafka</h3><p>节点规划</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip
port
x.x.x.x
9101
</code></pre></div></div><p>解压缩事先下载好的kafka-minion二进制包到/user/local/kafka-minion目录下</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tar -zxvf kafka_minion-1.0.2.tar.gz -C /root/software/
cd /opt/software/
</code></pre></div></div><p>编辑host文件，适配大数据平台<br /> <code class="language-plaintext highlighter-rouge">vim/etc/hosts</code></p><p>若kafka集群有域名地址<br /> 添加如下内容<br /> <code class="language-plaintext highlighter-rouge">x.x.x.x cdh-xxx</code></p><p>配置kafka-minion启动脚本<br /> <code class="language-plaintext highlighter-rouge">vi run.sh</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash
export KAFKA_BROKERS=dbjf-cmh12:9092
export VERSION=1.0.2
export KAFKA_VERSION=2.0.0
export TELEMETRY_PORT=9101 
 
export KAFKA_SASL_ENABLED=true
export KAFKA_SASL_MECHANISM=GSSAPI
export KAFKA_SASL_GSSAPI_AUTH_TYPE=KEYTAB_AUTH
export KAFKA_SASL_GSSAPI_KEY_TAB_PATH=/data/rec.keytab
export KAFKA_SASL_GSSAPI_KERBEROS_CONFIG_PATH=/etc/krb5.conf
export KAFKA_SASL_GSSAPI_SERVICE_NAME=kafka
export KAFKA_SASL_GSSAPI_USERNAME=rec
export KAFKA_SASL_GSSAPI_REALM=ZXJTKDC
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">nohup /root/software/kafka-minion/main &amp;</code></p><p>把kafka-minion配置为系统服务<br /> <code class="language-plaintext highlighter-rouge">vim /etc/systemd/system/kafka-minion.service</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Ps: ExecStart参数为现在服务安装路径
 [Unit]
Description=Kafka minion
After=network-online.target
[Service]
User=root
Restart=on-failure
ExecStart=/mnt/software/kafka-minion/run.sh
[Install]
WantedBy=multi-user.target
</code></pre></div></div><p>重新加载systemd系统</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload 
systemctl start kafka-minion
systemctl enable kafka-minion.service
</code></pre></div></div><p>检查服务状态<br /> <code class="language-plaintext highlighter-rouge">systemctl status kafka-minion</code></p><h3 id="node-exporter安装">Node-exporter安装</h3><p>节点规划</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip
port
localhost
9100
</code></pre></div></div><p>解压缩事先下载好的Node-exporter二进制包到/user/local/node-exporter目录下</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tar -zxvf node_exporter-0.18.1.linux-amd64.tar.gz -C /opt/software
cd /opt/software/
mv node_exporter-0.18.1.linux-arm64/ node-exporter
</code></pre></div></div><p>把Node-exporter配置为系统服务<br /> <code class="language-plaintext highlighter-rouge">vim /etc/systemd/system/node-exporter.service</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Ps: ExecStart参数为现在服务安装路径
 [Unit]
Description=Node exporter
After=network-online.target
[Service]
User=root
Restart=on-failure
ExecStart=/opt/software/node-exporter/node_exporter 
[Install]
WantedBy=multi-user.target
</code></pre></div></div><p>重新加载systemd系统</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload 
systemctl start node-exporter 
systemctl enable node-exporter.service
</code></pre></div></div><p>检查服务状态<br /> <code class="language-plaintext highlighter-rouge">systemctl status node-exporter</code></p><p>浏览器中打开 http://{ip-address}:9100/metrics若能看到相应的指标列表，则安装成功</p><p>【注】：操作系统指标需要被监控的每一台服务器（虚机）上都需要安装.</p><h3 id="postgres-exporter安装">Postgres-exporter安装</h3><p>节点规划</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip
port
localhost
9187
</code></pre></div></div><p>解压缩事先下载好的Postgres-exporter二进制包到/user/local/postgres-exporter目录下</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tar -zxvf postgres_exporter_v0.8.0_linux-amd64.tar.gz -C /opt/software
cd /opt/software
mv postgres_exporter_v0.8.0_linux-amd64/ postgres-exporter
</code></pre></div></div><p>把Postgres-exporter配置为系统服务<br /> <code class="language-plaintext highlighter-rouge">vim /etc/systemd/system/postgres_exporter.service</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Ps: ExecStart参数为现在服务安装路径
[Unit]
Description=Prometheus PostgreSQL Exporter
After=network.target
[Service]
Type=simple
Restart=always
User=postgres
Group=postgres
Environment=DATA_SOURCE_NAME="user=postgres host=xxx.xxx.xxx.xxx password='postgres' port=5432 dbname=postgres sslmode=disable"
ExecStart=/opt/software/postgres-exporter/postgres_exporter
[Install]
WantedBy=multi-user.target 
</code></pre></div></div><p>重新加载systemd系统</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload 
systemctl start postgres-exporter
systemctl enable postgres-exporter.service
</code></pre></div></div><p>检查服务状态<br /> <code class="language-plaintext highlighter-rouge">systemctl status postgres-exporter.service</code></p><p>Prometheus配置<br /> 更新Prometheus配置文件<br /> <code class="language-plaintext highlighter-rouge">vim /opt/software/prometheus/prometheus.yml</code></p><p>更新配置文件，内容如下：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Ps:
Prometheus 配置无需更改
node 配置需要按照实际服务器地址填写 可多个
spring boot配置需要按照服务所在服务器ip 端口填写
Postgres 若是安装在同一台机器则不需要改
scrape_configs:
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]
 
  - job_name: "kafka"
    static_configs:
      - targets: ["localhost:9308"]
 
  - job_name: "kafka-minion"
    static_configs:
      - targets: ["localhost:9101"]
 
  - job_name: "node"
    static_configs:
    - targets: ["localhost:9100"]
 
  - job_name: "springboot"
    metrics_path: /management/prometheus
    scrape_interval: 5s
    static_configs:
      - targets:
          - localhost:7020
          - localhost:7030
          - localhost:7100
          - localhost:7110
          - localhost:7120
          - localhost:7200
          - localhost:7350
          - localhost:7410
          - localhost:7430
          - localhost:7500
          - localhost:7510
          - localhost:7590
          - localhost:7600
          - localhost:8080
  
  - job_name: "postgres"
    static_configs:
      - targets: ["localhost:9187"] 
</code></pre></div></div><p>Grafana配置<br /> 首先以默认的的管理员账号登录admin/admin</p><p>配置Prometheus数据源</p><p>Grafana菜单栏选择Data Sources</p><p>点击[Add]按钮后选择“Prometheus”</p><p>配置Prometheus服务器的信息，如下图所示</p><p>【注】localhost更换为Prometheus服务的IP地址。</p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://lewinz.org" target="_blank">Lewin</a></li><li>本文链接：<a href="https://lewinz.org/wiki/middleware/" target="_blank">https://lewinz.org/wiki/middleware/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名</li></ul></div></article><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/wiki/middleware/', clientID: '3e7199ec0cac88c1d311', clientSecret: '55eef1180649f1417aa979dc9f50f66ed4a6e69a', repo: 'blog-comments', owner: 'Lewinz', admin: ['Lewinz'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@built/assets/search_data.json?v=1622424496', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7093222719567591" data-ad-slot="5263168187" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2021 <span title="Lewin">Lewin</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/Lewinz/lewinz.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://lewinz.org/" title="首页" target="">首页</a></li><li> <a href="https://lewinz.org/categories/" title="分类" target="">分类</a></li><li> <a href="https://lewinz.org/wiki/" title="维基" target="">维基</a></li><li> <a href="https://lewinz.org/links/" title="链接" target="">链接</a></li><li> <a href="https://lewinz.org/about/" title="关于" target="">关于</a></li><li><a href="https://lewinz.org/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul><script async src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span> <span id="busuanzi_container_page_pv" style="display:none"> / 本页访问量<span id="busuanzi_value_page_pv"></span>次 / 统计始于2021-04-21 </span></div></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-80669434-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
