<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>中间件部署文档 &mdash; 阿嫂</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/rouge-themes@master/dist/github.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/share.js/dist/css/share.min.css"><link rel="canonical" href="https://lewinz.org/wiki/middleware/"><link rel="alternate" type="application/atom+xml" title="阿嫂" href="https://lewinz.org/feed.xml"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/favicon.ico"><meta property="og:title" content="中间件部署文档"><meta name="keywords" content="中间件, 部署"><meta name="og:keywords" content="中间件, 部署"><meta name="description" content="JDK"><meta name="og:description" content="JDK"><meta property="og:url" content="https://lewinz.org/wiki/middleware/"><meta property="og:site_name" content="阿嫂"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-07-22"> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/main.js"></script> <script data-ad-client="ca-pub-7093222719567591" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://lewinz.org/" title="阿嫂"><span class="octicon octicon-mark-github"></span> 阿嫂</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://lewinz.org/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://lewinz.org/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://lewinz.org/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://lewinz.org/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://lewinz.org/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="中间件部署文档"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">中间件部署文档</h1></div></div><div class="column one-fourth mobile-hidden"></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" > <ins class="adsbygoogle content-header-ad" data-ad-client="ca-pub-7093222719567591" data-ad-slot="1650902835"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br /><article class="article-content markdown-body"><h1 id="jdk"><strong>JDK</strong></h1><h3 id="rpm方式">rpm方式</h3><p>上传准备好的离线安装包到服务器 安装<br /> <code class="language-plaintext highlighter-rouge">rpm -ivh jdk-8u181-linux-x64.rpm</code></p><h3 id="压缩包安装">压缩包安装</h3><p>上传准备好的压缩包到服务器</p><p>切换到安装目录<br /> <code class="language-plaintext highlighter-rouge">tar -zvxf /mnt/package/jdk-8u181-linux-x64.tar.gz</code></p><p>修改环境变量<br /> <code class="language-plaintext highlighter-rouge">vim /etc/profile</code></p><p>添加以下内容</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/mnt/app/jdk
<span class="nb">export </span><span class="nv">JRE_HOME</span><span class="o">=</span><span class="k">${</span><span class="nv">JAVA_HOME</span><span class="k">}</span>/jre
<span class="nb">export </span><span class="nv">CLASSPATH</span><span class="o">=</span>.:<span class="k">${</span><span class="nv">JAVA_HOME</span><span class="k">}</span>/lib:<span class="k">${</span><span class="nv">JRE_HOME</span><span class="k">}</span>/lib:<span class="nv">$CLASSPATH</span>
<span class="nb">export </span><span class="nv">JAVA_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">JAVA_HOME</span><span class="k">}</span>/bin:<span class="k">${</span><span class="nv">JRE_HOME</span><span class="k">}</span>/bin
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="k">${</span><span class="nv">JAVA_PATH</span><span class="k">}</span>
</code></pre></div></div><p>重新生效配置<br /> <code class="language-plaintext highlighter-rouge">source /etc/profile</code></p><h3 id="检查">检查</h3><p>输入<code class="language-plaintext highlighter-rouge">java -version</code>出现信息则说明安装成功</p><h1 id="postgresql"><strong>Postgresql</strong></h1><h3 id="在线安装">在线安装</h3><ol><li><p>安装RPM<br /> <code class="language-plaintext highlighter-rouge">yum install</code></p></li><li><p>安装客户端(若安装服务器，则不需要)<br /> <code class="language-plaintext highlighter-rouge">yum install postgresql12</code></p></li><li><p>安装服务端<br /> <code class="language-plaintext highlighter-rouge">yum install postgresql12-server</code></p></li></ol><h3 id="离线安装">离线安装</h3><p><strong>rpm包</strong></p><p>准备好如下rpm安装包</p><blockquote><p>libicu-50.2-4.el7_7.x86_64.rpm<br /> libxslt-1.1.28-5.el7.x86_64.rpm<br /> postgresql12-libs-12.4-1PGDG.rhel7.x86_64.rpm<br /> postgresql12-12.4-1PGDG.rhel7.x86_64.rpm<br /> postgresql12-server-12.4-1PGDG.rhel7.x86_64.rpm<br /> postgresql12-contrib-12.4-1PGDG.rhel7.x86_64.rpm</p></blockquote><p>**安装rpm包<按顺序执行>**</按顺序执行></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpm <span class="nt">-ivh</span> libicu-50.2-4.el7_7.x86_64.rpm <span class="nt">--force</span> <span class="nt">--nodeps</span>
 
rpm <span class="nt">-ivh</span> libxslt-1.1.28-5.el7.x86_64.rpm <span class="nt">--force</span> <span class="nt">--nodeps</span>
 
rpm <span class="nt">-ivh</span> postgresql12-libs-12.4-1PGDG.rhel7.x86_64.rpm <span class="nt">--force</span> <span class="nt">--nodeps</span>
 
rpm <span class="nt">-ivh</span> postgresql12-12.4-1PGDG.rhel7.x86_64.rpm <span class="nt">--force</span> <span class="nt">--nodeps</span>
 
rpm <span class="nt">-ivh</span> postgresql12-server-12.4-1PGDG.rhel7.x86_64.rpm <span class="nt">--force</span> <span class="nt">--nodeps</span>
 
rpm <span class="nt">-ivh</span> postgresql12-contrib-12.4-1PGDG.rhel7.x86_64.rpm <span class="nt">--force</span> <span class="nt">--nodeps</span>
</code></pre></div></div><p><strong>配置步骤</strong></p><p>始化数据库并启用自动启动 （可选）<br /> 初始化数据库<br /> <code class="language-plaintext highlighter-rouge">/usr/pgsql-12/bin/postgresql-12-setup initdb</code></p><p>设置开机启动pg服务<br /> <code class="language-plaintext highlighter-rouge">systemctl enable postgresql-12</code></p><p>启动pg服务<br /> <code class="language-plaintext highlighter-rouge">systemctl start postgresql-12</code></p><p>修改PostgreSQL远程连接配置<br /> <code class="language-plaintext highlighter-rouge">vim /var/lib/pgsql/12/data/pg_hba.conf</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">local   </span>all             all                                     peer
host    all             all             127.0.0.1/32            trust
host    all             all             all                     md5
host    replication     all             127.0.0.1/32            trust
host    replication     all             all                     md5
</code></pre></div></div><p>修改配置</p><p><code class="language-plaintext highlighter-rouge">vim /var/lib/pgsql/12/data/postgresql.conf</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 新增以下配置</span>
<span class="c"># 放开远程连接ip限制</span>
listen_addresses <span class="o">=</span> <span class="s1">'*'</span>
<span class="c"># 配置pg_stat_statements</span>
shared_preload_libraries <span class="o">=</span> <span class="s1">'pg_stat_statements'</span>
track_activity_query_size <span class="o">=</span> 2048
<span class="c"># 配置流复制模式，允许debezium cdc组件实时抓取 </span>
wal_level <span class="o">=</span> logical
max_wal_senders <span class="o">=</span> 10
max_replication_slots <span class="o">=</span> 10
pg_stat_statements.track <span class="o">=</span> all

<span class="c"># 修改以下配置</span>
max_wal_size <span class="o">=</span> 1GB
min_wal_size <span class="o">=</span> 100MB
</code></pre></div></div><p>重启服务<br /> <code class="language-plaintext highlighter-rouge">systemctl restart postgresql-12</code></p><p>修改postgres账号密码<br /> 使用postgres登入数据库<br /> <code class="language-plaintext highlighter-rouge">psql -h 127.0.0.1 -d postgres -U postgres</code></p><p>修改postgres密码<br /> <code class="language-plaintext highlighter-rouge">alter user postgres with password 'postgres';</code></p><p>加载pg_stat_statements<br /> <code class="language-plaintext highlighter-rouge">CREATE EXTENSION pg_stat_statements;</code></p><p><strong>挂载外部数据盘 ps: mnt为任意挂载盘</strong><br /> 停止pgsql <br /> <code class="language-plaintext highlighter-rouge">systemctl stop postgresql-12</code></p><p>编辑<code class="language-plaintext highlighter-rouge">vim /usr/lib/systemd/system/postgresql-12.service</code></p><p>修改文件中PGDATA路径配置为外部数据盘相应文件夹地址<br /> 配置由<code class="language-plaintext highlighter-rouge">Environment=PGDATA=/var/lib/pgsql/12/data/</code><br /> 变为<code class="language-plaintext highlighter-rouge">Environment=PGDATA=/mnt/pg/data/</code></p><p>将文件夹复制到外部数据盘<br /> <code class="language-plaintext highlighter-rouge">mv /var/lib/pgsql/12/data/ /mnt/pg/data/</code></p><p>将数据目录文件夹所有者改为postgres用户, postgres用户组<br /> <code class="language-plaintext highlighter-rouge">chown postgres:postgres /mnt/pg/data/ -R</code></p><p>访问权限改为 750或700<br /> <code class="language-plaintext highlighter-rouge">chmod 750 -R /mnt/pg/data/</code><br /> 执行 <code class="language-plaintext highlighter-rouge">systemctl daemon-reload</code><br /> 以后修改配置文件就在/mnt/pg/data下面修改</p><p>重启服务<br /> <code class="language-plaintext highlighter-rouge">systemctl restart postgresql-12</code></p><h3 id="postgresql主从">Postgresql主从</h3><p>安装PG从库<br /> 按照前面的安装操作，在另一台服务器安装从库pg。 <br /> <strong>！！！从库在部署时不能初始化数据库，否则会导致主从库序列号不一致。</strong></p><p><strong>配置步骤</strong></p><p>准备流复制角色 ps: 密码可更改<br /> 在主库中创建进行流复制的角色</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE ROLE repuser WITH
  LOGIN
  REPLICATION
  CONNECTION LIMIT 5
  PASSWORD <span class="s1">'1qazXSW@3edc'</span><span class="p">;</span>
</code></pre></div></div><p>修改主库配置<br /> 打开主库配置文件夹<br /> <code class="language-plaintext highlighter-rouge">cd /mnt/pg/data</code></p><p><code class="language-plaintext highlighter-rouge">vim pg_hba.conf</code> 在最后一行添加</p><p><code class="language-plaintext highlighter-rouge">host replication repuser 从库ip/32 md5</code></p><p><code class="language-plaintext highlighter-rouge">vim postgresql.conf</code> 修改以下变量</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>archive_mode <span class="o">=</span> on
archive_command <span class="o">=</span> <span class="s1">'/bin/date'</span>
max_wal_senders <span class="o">=</span> 10
wal_keep_segments <span class="o">=</span> 16
synchronous_standby_names <span class="o">=</span> <span class="s1">'*'</span>
</code></pre></div></div><p>重启主库 使配置生效</p><p>从库配置<br /> 使用以下命令 在两边服务器中检查， 主从服务器连通性</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ping ip
    telnet ip 5432
</code></pre></div></div><p>确认无误后，在从库服务器执行以下命令，备份主库数据</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /mnt/pg/     打开从库pg的数据文件夹处  
pg_basebackup <span class="nt">-R</span> <span class="nt">-D</span> /mnt/pg/backup <span class="nt">-Fp</span> <span class="nt">-Xs</span> <span class="nt">-v</span> <span class="nt">-P</span> <span class="nt">-h</span> 主库ip <span class="nt">-p</span> 5432 <span class="nt">-U</span> repuser  
</code></pre></div></div><p>将原数据文件夹备份 再将backup改名为data<br /> 更改data文件夹的用户组，权限</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chown </span>postgres:postgres data <span class="nt">-R</span>
<span class="nb">chmod </span>750 <span class="nt">-R</span> data
</code></pre></div></div><p>检查 postgresql.auto.conf 文件里是否包含如下内容：</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>primary_conninfo <span class="o">=</span> <span class="s1">'user=repuser password=''1qazXSW@3edc'' host=主库IP port=5432 sslmode=prefer sslcompression=0 gssencmode=prefer krbsrvname=postgres target_session_attrs=any'</span>
</code></pre></div></div><p>重启从库PG<br /> 检查主从是否成功</p><p>在主库中查询流复制信息<br /> <code class="language-plaintext highlighter-rouge">select * from pg_stat_replication;</code></p><p>在主库中添加或修改数据，在从库中查看。</p><h1 id="mysql">MySql</h1><h3 id="单节点安装">单节点安装</h3><p>检查插件</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 会与mysql冲突，如果预装了，先卸载</span>
rpm <span class="nt">-qa</span>|grep mariadb
rpm <span class="nt">-e</span> <span class="nt">--nodeps</span> mariadb-xxxxxxxx.x86_64

<span class="c"># mysql安装依赖插件，如果没有，先安装</span>
rpm <span class="nt">-qa</span>|grep libaio
yum <span class="nb">install </span>libaio
</code></pre></div></div><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 安装mysql</span>
rpm <span class="nt">-ivh</span> mysql-community-common-5.7.22-1.el7.x86_64.rpm
rpm <span class="nt">-ivh</span> mysql-community-libs-5.7.22-1.el7.x86_64.rpm
rpm <span class="nt">-ivh</span> mysql-community-client-5.7.22-1.el7.x86_64.rpm
rpm <span class="nt">-ivh</span> mysql-community-server-5.7.22-1.el7.x86_64.rpm
</code></pre></div></div><p>安装如果报错<code class="language-plaintext highlighter-rouge">perl(Getopt::Long) is needed</code><br /> 执行<code class="language-plaintext highlighter-rouge">yum install perl</code></p><p>如果报错<code class="language-plaintext highlighter-rouge">warning: mysql-community-server-5.7.22-1.el7.x86_64.rpm: Header V3 DSA/SHA1 Signature, key ID 5072e1f5: NOKEY</code><br /> 解决办法：<code class="language-plaintext highlighter-rouge">在rpm命令后加上 --force --nodeps</code></p><p>初始化数据库，自动创建data文件目录<br /> <code class="language-plaintext highlighter-rouge">mysqld --initialize-insecure --user=mysql</code></p><p>将<code class="language-plaintext highlighter-rouge">/var/lib/mysql</code>文件所有用户修改为mysql <code class="language-plaintext highlighter-rouge">chown mysql:mysql /var/lib/mysql -R</code></p><p>修改mysql配置<br /> <code class="language-plaintext highlighter-rouge">vi /etc/my.cnf</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 设置字符编码集 utf8mb4</span>
<span class="o">[</span>client] 
default-character-set <span class="o">=</span> utf8mb4 
 
<span class="o">[</span>mysql] 
default-character-set <span class="o">=</span> utf8mb4 
 
<span class="o">[</span>mysqld] 
character-set-client-handshake <span class="o">=</span> FALSE 
character-set-server <span class="o">=</span> utf8mb4 
collation-server <span class="o">=</span> utf8mb4_general_ci 
<span class="nv">init_connect</span><span class="o">=</span><span class="s1">'SET NAMES utf8mb4'</span>

<span class="nv">user</span><span class="o">=</span>mysql
skip-name-resolve
<span class="nv">max_connections</span><span class="o">=</span>500
<span class="nv">wait_timeout</span><span class="o">=</span>31536000
<span class="nv">interactive_timeout</span><span class="o">=</span>31536000
</code></pre></div></div><p>启动mysql<br /> <code class="language-plaintext highlighter-rouge">systemctl start mysqld.service</code></p><p>登陆mysql修改密码</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql <span class="nt">-u</span> root
 
update mysql.user <span class="nb">set </span>authentication_string <span class="o">=</span> password<span class="o">(</span><span class="s1">'123456'</span><span class="o">)</span> where user <span class="o">=</span> <span class="s1">'root'</span> and host <span class="o">=</span> <span class="s1">'localhost'</span><span class="p">;</span>
 
grant all privileges on <span class="k">*</span>.<span class="k">*</span> to <span class="s1">'root'</span>@<span class="s1">'%'</span> identified by <span class="s1">'123456'</span> with grant option<span class="p">;</span>
 
flush privileges<span class="p">;</span>
</code></pre></div></div><p>退出mysql后，设置开机自启，重启mysql</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl stop mysqld.service
systemctl <span class="nb">enable </span>mysqld.service
systemctl list-unit-files | <span class="nb">grep </span>mysqld
systemctl start mysqld.service
</code></pre></div></div><p>linux上Mysql登录</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 使用root登录，-p代表有密码</span>
mysql <span class="nt">-u</span> root <span class="nt">-h</span> 127.0.0.1 <span class="nt">-p</span>
</code></pre></div></div><h3 id="主从模式安装">主从模式安装</h3><p><strong>主节点修改</strong></p><p><code class="language-plaintext highlighter-rouge">vim /etc/my.cnf</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## 设置server_id，一般设置为IP,注意要唯一</span>
server-id<span class="o">=</span>125107
<span class="c">## 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）</span>
binlog-ignore-db<span class="o">=</span>mysql
binlog-ignore-db<span class="o">=</span>sys
binlog-ignore-db<span class="o">=</span>information_schema
binlog-ignore-db<span class="o">=</span>performance_schem
<span class="c">## 开启二进制日志功能，可以随便取，最好有含义（关键就是这里了）</span>
log-bin<span class="o">=</span>mysql-bin
<span class="c">## 为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存</span>
<span class="nv">binlog_cache_size</span><span class="o">=</span>16M
<span class="c">## 主从复制的格式（mixed,statement,row，默认格式是statement）</span>
<span class="nv">binlog_format</span><span class="o">=</span>mixed
<span class="c">## 二进制日志自动删除/过期的天数。默认值为0，表示不自动删除。</span>
<span class="nv">expire_logs_days</span><span class="o">=</span>30
<span class="c">## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。</span>
<span class="c">## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致</span>
<span class="nv">slave_skip_errors</span><span class="o">=</span>1062
<span class="c">## 控制binlog的写入频率。每执行多少次事务写入一次</span>
<span class="c">## 这个参数性能消耗很大，但可减小MySQL崩溃造成的损失，为0表示不控制</span>
sync_binlog <span class="o">=</span> 1
innodb_flush_log_at_trx_commit <span class="o">=</span> 1
</code></pre></div></div><p>重启主节点服务</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart mysqld.service
</code></pre></div></div><p>创建同步用户</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 创建给从节点使用</span>
CREATE USER <span class="s1">'slave'</span>@<span class="s1">'%'</span> IDENTIFIED BY <span class="s1">'a123456'</span><span class="p">;</span>

GRANT REPLICATION SLAVE, REPLICATION CLIENT ON <span class="k">*</span>.<span class="k">*</span> TO <span class="s1">'slave'</span>@<span class="s1">'%'</span><span class="p">;</span>
</code></pre></div></div><p><strong>从节点修改</strong></p><p><code class="language-plaintext highlighter-rouge">vim /etc/my.cnf</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## 设置server_id，一般设置为IP,注意要唯一</span>
server-id<span class="o">=</span>125111
<span class="c">## 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）</span>
binlog-ignore-db<span class="o">=</span>mysql
binlog-ignore-db<span class="o">=</span>sys
binlog-ignore-db<span class="o">=</span>information_schema
binlog-ignore-db<span class="o">=</span>performance_schem
<span class="c">## 开启二进制日志功能，以备Slave作为其它Slave的Master时使用</span>
<span class="c">#log-bin=mysql-slave1-bin</span>
<span class="c">## 为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存</span>
<span class="nv">binlog_cache_size</span><span class="o">=</span>16M
<span class="c">## 主从复制的格式（mixed,statement,row，默认格式是statement）</span>
<span class="nv">binlog_format</span><span class="o">=</span>mixed
<span class="c">## 二进制日志自动删除/过期的天数。默认值为0，表示不自动删除。</span>
<span class="nv">expire_logs_days</span><span class="o">=</span>30
<span class="c">## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。</span>
<span class="c">## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致</span>
<span class="nv">slave_skip_errors</span><span class="o">=</span>1062
<span class="c">## relay_log配置中继日志</span>
<span class="nv">relay_log</span><span class="o">=</span>mysql-relay-bin
<span class="c">## log_slave_updates表示slave将复制事件写进自己的二进制日志</span>
<span class="c">## 主要为了作为其他的master</span>
<span class="c">#log_slave_updates=ON</span>
<span class="c">## 防止改变数据(除了特殊的线程)</span>
<span class="c">#read_only=1(为了使备机随时转正，所以这里允许写)</span>
<span class="c">## MySQL主从复制的时候，当Master和Slave之间的网络中断，但是Master和Slave无法察觉的情况下（比如防火墙或者路由问题）。Slave会等待slave_net_timeout设置的秒数后，才能认为网络出现故障，然后才会重连并且追赶这段时间主库的数据,默认60</span>
slave-net-timeout <span class="o">=</span> 20                    
<span class="c">## 如果启用，此变量将在服务器启动后立即启用自动中继日志恢复。</span>
relay_log_recovery <span class="o">=</span> ON
<span class="c">## 该变量确定从站在中继日志中的位置是写入FILE还是写入表</span>
relay_log_info_repository <span class="o">=</span> TABLE
</code></pre></div></div><p>重启从节点服务</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart mysqld.service
</code></pre></div></div><p>登录从节点mysql</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 命令信息需要修改，在主节点执行命令 show master status\G; 获取</span>
change master to <span class="nv">master_host</span><span class="o">=</span><span class="s1">'47.117.136.250'</span>, <span class="nv">master_user</span><span class="o">=</span><span class="s1">'slave'</span>, <span class="nv">master_password</span><span class="o">=</span><span class="s1">'a123456'</span>, <span class="nv">master_port</span><span class="o">=</span>3306, <span class="nv">master_log_file</span><span class="o">=</span><span class="s1">'mysql-bin.000002'</span>, <span class="nv">master_log_pos</span><span class="o">=</span>154, <span class="nv">master_connect_retry</span><span class="o">=</span>30,master_heartbeat_period<span class="o">=</span>10<span class="p">;</span>
</code></pre></div></div><p>开始主从复制</p><p><code class="language-plaintext highlighter-rouge">start slave;</code></p><p>查看主从同步状态<br /> <code class="language-plaintext highlighter-rouge">show slave status\G;</code></p><p>Slave_IO_Running/Slave_SQL_Running 两个属性都为YES即为复制成功</p><p>若主从复制信息设置错误，可通过下列命令重置信息</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 停止已经启动的绑定</span>
stop slave<span class="p">;</span>
<span class="c"># 重置绑定</span>
reset master<span class="p">;</span>
<span class="c"># 启动复制</span>
start slave<span class="p">;</span>
</code></pre></div></div><p><strong>常见错误：</strong></p><p>查看错误日志 <code class="language-plaintext highlighter-rouge">tail -f -n 1000 /var/log/mysqld.log</code></p><p>errNum: <br /> <strong>1236</strong> 复制信息有误，重新设置。</p><p>errNum: <br /> <strong>1593</strong> 在mysql中使用 <code class="language-plaintext highlighter-rouge">show variables like '%server_%';</code> 查看 server_id/server_uuid 是否配置生效，server_id配置在my.cnf中，server_uuid在auto.cnf中。</p><h1 id="nginx">Nginx</h1><h3 id="安装相关依赖">安装相关依赖</h3><p><code class="language-plaintext highlighter-rouge">yum -y install gcc gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel gd gd-devel</code></p><h3 id="安装nginx">安装nginx</h3><p>解压ngnix安装包 <code class="language-plaintext highlighter-rouge">tar -zxvf nginx-1.17.3.tar.gz</code></p><p>进入解压缩目录,编译监控插件<br /> <code class="language-plaintext highlighter-rouge">./configure --add-module=/mnt/nginx/nginx-module-vts</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make
make <span class="nb">install</span>
</code></pre></div></div><p>启动<br /> <code class="language-plaintext highlighter-rouge">cd /usr/local/nginx/sbin</code><br /> ./nginx</p><h3 id="配置">配置</h3><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server <span class="o">{</span>
    listen 8000<span class="p">;</span>
    server_name info<span class="p">;</span>
    client_max_body_size 20M<span class="p">;</span>
    root /data/info/99-admin-web/info-web<span class="p">;</span>
 
    include /etc/nginx/default.d/<span class="k">*</span>.conf<span class="p">;</span>
 
    location /<span class="o">{</span>
        root /data/info/99-admin-web<span class="p">;</span>
        index index.html index.htm<span class="p">;</span>
    <span class="o">}</span>
 
    location /info-api/ <span class="o">{</span>
        proxy_pass http://gateway地址:8080/<span class="p">;</span>
    <span class="o">}</span>
    <span class="c">#添加监控接口/status/：</span>
    location /status <span class="o">{</span>             
        vhost_traffic_status_display<span class="p">;</span>             
        vhost_traffic_status_display_format html<span class="p">;</span>         
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><h1 id="nacos">Nacos</h1><h3 id="单机部署">单机部署</h3><p><strong>通过源码或者发行包获取</strong></p><p>从 Github 上下载源码方式</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/alibaba/nacos.git
<span class="nb">cd </span>nacos/
mvn <span class="nt">-Prelease-nacos</span> clean <span class="nb">install</span> <span class="nt">-U</span>  
<span class="nb">ls</span> <span class="nt">-al</span> distribution/target/
<span class="nb">cd </span>distribution/target/nacos-server-<span class="nv">$version</span>/nacos/bin
</code></pre></div></div><p>下载编译后压缩包方式</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/alibaba/nacos/releases
unzip nacos-server-<span class="nv">$version</span>.zip 或者 <span class="nb">tar</span> <span class="nt">-xvf</span> nacos-server-<span class="nv">$version</span>.tar.gz
<span class="nb">cd </span>nacos/bin
</code></pre></div></div><p><strong>单机启动</strong> <code class="language-plaintext highlighter-rouge">sh startup.sh -m standalone</code></p><p>关闭服务 <code class="language-plaintext highlighter-rouge">sh shutdown.sh</code></p><h3 id="集群部署">集群部署</h3><p>安装数据库，版本要求：5.6.5+</p><p>初始化mysql数据库，数据库初始化文件：nacos-mysql.sql</p><p>修改conf/application.properties文件，添加mysql数据源的url、用户名和密码。</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spring.datasource.platform<span class="o">=</span>mysql
db.num<span class="o">=</span>1
db.url.0<span class="o">=</span>jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding<span class="o">=</span>utf8&amp;connectTimeout<span class="o">=</span>1000&amp;socketTimeout<span class="o">=</span>3000&amp;autoReconnect<span class="o">=</span><span class="nb">true
</span>db.user<span class="o">=</span>user_name
db.password<span class="o">=</span><span class="nb">pwd</span>
</code></pre></div></div><p>修改conf目录下cluster.conf文件</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xxx.xxx.xxx.16:8848
xxx.xxx.xxx.17:8848
xxx.xxx.xxx.18:8848
</code></pre></div></div><p>配置mysql数据库</p><p>无参模式启动startup.sh脚本<br /> <code class="language-plaintext highlighter-rouge">sh startup.sh</code></p><h1 id="kafka">Kafka</h1><h3 id="zookeeper单节点安装可使用kafka自带">zookeeper单节点安装（可使用kafka自带）</h3><p><strong>解压zookeeper压缩包（必须是带”bin”的压缩包，否则启动会报错）</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /mnt/zookeeper/
<span class="nb">tar</span> <span class="nt">-zxvf</span> apache-zookeeper-3.6.2-bin.tar.gz
</code></pre></div></div><p><strong>修改配置文件</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /mnt/zookeeper/apache-zookeeper-3.6.2-bin/conf
<span class="nb">cp </span>zoo_sample.cfg zoo.cfg
vi zoo.cfg
</code></pre></div></div><p><strong>配置数据路径和日志路径</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">dataDir</span><span class="o">=</span>/mnt/data/zookeeper
<span class="nv">dataLogDir</span><span class="o">=</span>/mnt/logs/zookeeper

<span class="c"># 自动清理日志&lt;非必须&gt; 3.4之后版本可配置</span>
autopurge.snapRetainCount<span class="o">=</span>3
autopurge.purgeInterval<span class="o">=</span>1
</code></pre></div></div><p><strong>配置环境变量</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">ZOOKEEPER_INSTALL</span><span class="o">=</span>/mnt/zookeeper/apache-zookeeper-3.6.2-bin/
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$ZOOKEEPER_INSTALL</span>/bin
</code></pre></div></div><p><strong>启动zookeeper服务</strong></p><p><code class="language-plaintext highlighter-rouge">/mnt/zookeeper/apache-zookeeper-3.6.2-bin/bin/zkServer.sh start</code></p><p><strong>启动成功</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ZooKeeper JMX enabled by default
Using config: /usr/local/zookeeper-3.4.13/bin/../conf/zoo.cfg
Starting zookeeper ... STARTED
</code></pre></div></div><h3 id="zookeeper集群安装">zookeeper集群安装</h3><p>多台服务器zookeeper单节点安装完毕之后</p><p>在zoo.cfg配置的data目录下新增myid文件 ` echo 1 &gt; /mnt/software/zookeeper/data/myid`</p><p><code class="language-plaintext highlighter-rouge">vim /mnt/software/zookeeper/conf/zoo.cfg</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ip:port:port&lt;port:port为选举leader使用，默认2888:3888，如果是一台服务器部署集群，使用多个不同端口即可&gt;</span>
server.1<span class="o">=</span>xx.xx.xx.xx:2888:3888
server.2<span class="o">=</span>xx.xx.xx.xx:2888:3888
server.3<span class="o">=</span>xx.xx.xx.xx:2888:2888
</code></pre></div></div><p>启动服务。</p><h3 id="kafka单节点部署">kafka单节点部署</h3><p>解压kafka压缩包</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /mnt/tools

<span class="nb">tar</span> <span class="nt">-zxvf</span> kafka_2.13-2.6.0.tgz
<span class="nb">mv </span>kafka_2.13-2.6.0 /mnt/software/kafka

<span class="nb">cd</span> /mnt/software/kafka
<span class="nb">mkdir </span>zookeeper
<span class="nb">mkdir </span>log
<span class="nb">mkdir </span>log/zookeeper
<span class="nb">mkdir </span>log/kafka
</code></pre></div></div><p>修改zookeeper配置</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim config/zookeeper.properties
<span class="nv">dataDir</span><span class="o">=</span> /mnt/software/kafka/zookeeper
</code></pre></div></div><p>修改kafka配置</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim config/server.properties
<span class="c">#修改这几项</span>
log.dirs<span class="o">=</span>/mnt/software/kafka/log/kafka  <span class="c">#日志存放路径</span>
<span class="nv">listeners</span><span class="o">=</span>PLAINTEXT://10.17.64.110:9092 <span class="c">#IP填本机地址 外网/内网可访问地址</span>
zookeeper.connect<span class="o">=</span>10.17.64.110:2181  <span class="c">#IP填zookeeper安装地址</span>
</code></pre></div></div><p>先启动zookeeper</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh bin/zookeeper-server-start.sh <span class="nt">-daemon</span>  config/zookeeper.properties
sh bin/kafka-server-start.sh <span class="nt">-daemon</span> config/server.properties
</code></pre></div></div><p>创建 Topic</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin/kafka-topics.sh <span class="nt">--create</span> <span class="nt">--zookeeper</span> localhost:2181 <span class="nt">--replication-factor</span> 1 <span class="nt">--partitions</span> 1 <span class="nt">--topic</span> <span class="nb">test</span>
</code></pre></div></div><p>查看 topic 列表</p><p><code class="language-plaintext highlighter-rouge">bin/kafka-topics.sh --list --zookeeper localhost:2181</code></p><p>查看描述 topics 信息</p><p><code class="language-plaintext highlighter-rouge">bin/kafka-topics.sh --describe --zookeeper localhost:2181 --topic test</code></p><p>启动生产者</p><p><code class="language-plaintext highlighter-rouge">bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test</code></p><p>启动消费者</p><p><code class="language-plaintext highlighter-rouge"> bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --from-beginning --from-beginning 表示从起始位读取 </code></p><p>启动先zookeeper 停止先kafka</p><h3 id="kafka集群部署">kafka集群部署</h3><p>复制kafka文件夹到其它服务器</p><p>在/mnt/kafka/zookeeper下添加myid文件，写入服务broker.id属性值<br /> 例如 echo 0 &gt; myid</p><p>修改zookeeper配置文件<br /> <code class="language-plaintext highlighter-rouge">config/zookeeper.properties</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#注释掉</span>
<span class="c">#maxClientCnxns=0</span>

<span class="c">#设置连接参数，添加如下配置</span>
<span class="nv">tickTime</span><span class="o">=</span>2000　　　　#为zk的基本时间单元，毫秒
<span class="nv">initLimit</span><span class="o">=</span>10　　　　 <span class="c">#Leader-Follower初始通信时限 tickTime*10</span>
<span class="nv">syncLimit</span><span class="o">=</span>5　　　　　#Leader-Follower同步通信时限 tickTime<span class="k">*</span>5
 
<span class="c">#设置broker Id的服务地址 id值与服务器IP对应</span>
server.0<span class="o">=</span>10.17.64.110:2888:3888
server.1<span class="o">=</span>10.17.64.111:2888:3888
server.2<span class="o">=</span>10.17.64.112:2888:3888
</code></pre></div></div><p>修改kafka配置文件 config/server.properties</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>broker.id<span class="o">=</span>0  <span class="c"># kafka实例的唯一标识，用整数表示，使用不同的整数值将集群中的kafka实例区分即可</span>

<span class="c"># topic 在当前broker上的分片个数，与broker保持一致</span>
num.partitions<span class="o">=</span>3
zookeeper.connect<span class="o">=</span>node1:2181,node2:2181,node3:2181
 
1. broker.id：同一个集群中，每台机器均不能一样
2. zookeeper.connect：有几台zookeeper服务器，设置为几台台，必须全部加进去
3. listeners：在配置集群的时候，必须设置，不然以后的操作会报找不到leader的错误
</code></pre></div></div><p>配置完成后先启动zookeeper 保证服务都启动后在启动kafka</p><h1 id="es集群搭建">ES集群搭建</h1><p>解压安装包</p><p>安装rpm<br /> <code class="language-plaintext highlighter-rouge">rpm -ivh elasticsearch-7.8.0-x86_64.rpm</code></p><p>更新es配置<br /> <code class="language-plaintext highlighter-rouge">vim /etc/elasticsearch/elasticsearch.yml</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Use a descriptive name for your cluster:</span>
<span class="c">#</span>
cluster.name: elasticsearch
///节点名称
<span class="c"># Use a descriptive name for the node:</span>
<span class="c">#</span>
node.name: <span class="s1">'es-node1'</span>
///数据以及日志存放路径
<span class="c"># Path to directory where to store the data (separate multiple locations by comma):</span>
<span class="c">#</span>
path.data: /data/elasticsearch/data
<span class="c">#</span>
<span class="c"># Path to log files:</span>
<span class="c">#</span>
path.logs: /data/elasticsearch/logs
///本机ip以及端口
<span class="c"># Set the bind address to a specific IP (IPv4 or IPv6):</span>
<span class="c">#</span>
network.host: 10.0.209.47
network.bind_host: 10.0.209.47
network.publish_host: 10.0.209.47
<span class="c">#</span>
<span class="c"># Set a custom port for HTTP:</span>
<span class="c">#</span>
http.port: 9200
///集群ip配置以及主节点数（计算方式：total number of master-eligible nodes / 2 + 1）
<span class="c"># Pass an initial list of hosts to perform discovery when new node is started:</span>
<span class="c"># The default list of hosts is ["127.0.0.1", "[::1]"]</span>
<span class="c">#</span>
discovery.zen.ping.unicast.hosts: <span class="o">[</span><span class="s2">"10.0.209.47"</span>, <span class="s2">"10.0.209.44"</span>,<span class="s2">"10.0.209.43"</span><span class="o">]</span>
<span class="c">#</span>
<span class="c"># Prevent the "split brain" by configuring the majority of nodes (total number of master-eligible nodes / 2 + 1):</span>
<span class="c">#</span>
discovery.zen.minimum_master_nodes: 2
</code></pre></div></div><p>设置jvm参数<br /> <code class="language-plaintext highlighter-rouge">vim etc/elasticsearch/jvm.options （内存允许 设置31g）</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-Xms31g</span>
<span class="nt">-Xmx31g</span>
</code></pre></div></div><p>配置密码 （公网环境需要设置，客户服务器视情况而定 内网访问可不需要密码）</p><p>执行以下命令输入ElasticSearch的密码</p><p><code class="language-plaintext highlighter-rouge">/usr/share/elasticsearch/bin/elasticsearch-setup-passwords interactive</code></p><p>配置开机启动</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl <span class="nb">enable </span>elasticsearch.service
systemctl start elasticsearch
systemctl status elasticsearch
</code></pre></div></div><h1 id="redis">Redis</h1><h3 id="单机搭建">单机搭建</h3><p>解压</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tar</span> –zxvf redis-5.0.5.tar.gz

<span class="nb">cd</span> /mnt/software/redis/

&lt;<span class="nb">sudo</span><span class="o">&gt;</span> make <span class="nv">MALLOC</span><span class="o">=</span>libc <span class="o">&amp;&amp;</span> make <span class="nb">install</span>
</code></pre></div></div><p>如果在此步报错<br /> cc: 错误：../deps/hiredis/libhiredis.a：没有那个文件或目录<br /> cc: 错误：../deps/lua/src/liblua.a：没有那个文件或目录</p><p>切换至deps/执行</p><p><code class="language-plaintext highlighter-rouge">&lt;sudo&gt; make lua hiredis linenoise</code></p><p>再执行<code class="language-plaintext highlighter-rouge">&lt;sudo&gt; make MALLOC=libc &amp;&amp; make install</code>即可</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>src
./redis-server
</code></pre></div></div><h3 id="redis配置成服务">Redis配置成服务</h3><p>修改配置文件redis.conf<br /> <code class="language-plaintext highlighter-rouge">vim /mnt/software/redis/redis.conf</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 三个参数都是修改</span>
<span class="nb">bind </span>0.0.0.0
logfile /mnt/software/redis/logs/redis.log
<span class="nb">dir</span> /mnt/software/redis/data
</code></pre></div></div><p>将配置文件拷贝到/etc/init.d目录下</p><p><code class="language-plaintext highlighter-rouge">cp /mnt/software/redis/redis.conf /etc/redis/redis.conf</code></p><p>将redis启动脚本复制到/etc/init.d目录下</p><p><code class="language-plaintext highlighter-rouge">cp /mnt/software/redis/utils/redis_init_script /etc/init.d/redis</code></p><p>修改启动脚本</p><p><code class="language-plaintext highlighter-rouge">vim /etc/init.d/redis</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 修改参数，文件名为刚刚复制到此目录的 conf 文件</span>
<span class="nv">CONF</span><span class="o">=</span><span class="s2">"/etc/redis/6379.conf"</span>
</code></pre></div></div><p>redis文件添加到 systemctl</p><p><code class="language-plaintext highlighter-rouge">systemctl enable redis</code></p><p>重启Redis</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;<span class="nb">sudo</span><span class="o">&gt;</span> systemctl stop redis
&lt;<span class="nb">sudo</span><span class="o">&gt;</span> systemctl start redis
</code></pre></div></div><h3 id="redis配置主从复制">Redis配置主从复制</h3><p>1）各结点启动redis 服务</p><p><code class="language-plaintext highlighter-rouge">sudo systemctl start redis</code></p><p>2）登陆从结点，查看主从复制情况</p><p><code class="language-plaintext highlighter-rouge">/data/redis/redis-5.0.5/src/redis-cli info Replication</code></p><p>3）设置开机自启</p><p><code class="language-plaintext highlighter-rouge">$ sudo /sbin/chkconfig redis on</code></p><p>从redis149上配置文件6379.conf添加</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>slaveof 10.16.212.224 6379
slave-read-only <span class="nb">yes</span>
</code></pre></div></div><p>4）验证</p><p>执行redis-cli 连接到redis-service</p><p>执行info Replication命令查看状态</p><p>看到从节点上有</p><p>master_host: 10.16.212.224以及slave_read_only:1字样即为配置成功</p><h3 id="集群部署-1">集群部署</h3><p>暂时先参考此文档：https://www.jianshu.com/p/8045b92fafb2</p><h1 id="监控系统">监控系统</h1><h3 id="prometheus">Prometheus</h3><p>节点规划</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip
port
x.x.x.x
9090
</code></pre></div></div><p>解压缩事先下载好的Prometheus二进制包到/user/local/prometheus目录下</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tar</span> <span class="nt">-zxvf</span> prometheus-2.14.0.linux-amd64.tar.gz <span class="nt">-C</span> /opt/software/
<span class="nb">cd</span> /opt/software/
<span class="nb">mv </span>prometheus-2.14.0.linux-amd64/ prometheus
</code></pre></div></div><p>验证版本信息，确认安装包没有问题</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>prometheus/
./prometheus –version
</code></pre></div></div><p>备份配置文件，后续修改prometheus.yml配置文件来收集监控信息<br /> <code class="language-plaintext highlighter-rouge">cp prometheus.yml prometheus.yml-bak</code></p><p>将Prometheus配置为系统服务<br /> <code class="language-plaintext highlighter-rouge">vim /etc/systemd/system/prometheus.service</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Ps: ExecStart参数为现在服务安装路径 storage.tsdb.path为数据存储路径 可修改
<span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Prometheus Server
<span class="nv">Documentation</span><span class="o">=</span>https://prometheus.io/docs/introduction/overview/
<span class="nv">After</span><span class="o">=</span>network-online.target
<span class="o">[</span>Service]
<span class="nv">User</span><span class="o">=</span>root
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">ExecStart</span><span class="o">=</span>/opt/software/prometheus/prometheus <span class="se">\</span>
 <span class="nt">--config</span>.file<span class="o">=</span>/opt/software/prometheus/prometheus.yml <span class="se">\</span>
 <span class="nt">--storage</span>.tsdb.path<span class="o">=</span>/opt/software/prometheus/data
<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div><p>重新加载systemd系统</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload 
systemctl start prometheus 
systemctl <span class="nb">enable </span>prometheus.service
</code></pre></div></div><p>检查服务状态<br /> <code class="language-plaintext highlighter-rouge">systemctl status prometheus</code></p><p>浏览器中打开 http://x.x.x.x:9090/若能看到内容，安装成功</p><h3 id="grafana安装">Grafana安装</h3><p>节点规划</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip
port
x.x.x.x
3000
</code></pre></div></div><p>执行rpm安装事前下载好的rpm安装包<br /> <code class="language-plaintext highlighter-rouge">rpm -Uvh grafana-6.4.4-1.x86_64.rpm</code></p><p>重新加载systemd系统</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload 
systemctl start grafana-server.service
systemctl <span class="nb">enable </span>grafana-server.service
</code></pre></div></div><p>检查服务状态<br /> <code class="language-plaintext highlighter-rouge">systemctl status grafana-server.service</code></p><p>浏览器中打开 http://xxx.xxx.xxx.xxx:3000/若能看到登录页面，安装成功</p><h3 id="kafka-exporter--ps适用于未加权限的kafka">Kafka-exporter ps:适用于未加权限的kafka</h3><p>节点规划</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip
port
x.x.x.x
9308
</code></pre></div></div><p>解压缩事先下载好的kafka-exporter二进制包到/user/local/kafka-exporter目录下</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tar</span> <span class="nt">-zxvf</span> kafka_exporter-1.2.0.linux-amd64.tar.gz <span class="nt">-C</span> /opt/software/
<span class="nb">cd</span> /opt/software/
<span class="nb">mv </span>kafka_exporter-1.2.0.linux-amd64/ kafka-exporter
</code></pre></div></div><p>编辑host文件，适配大数据平台<br /> <code class="language-plaintext highlighter-rouge">vim/etc/hosts</code></p><p>若kafka集群有域名地址<br /> 添加如下内容<br /> <code class="language-plaintext highlighter-rouge">x.x.x.x cdh-xxx</code></p><p>把kafka-exporter配置为系统服务<br /> <code class="language-plaintext highlighter-rouge">vim /etc/systemd/system/kafka-exporter.service</code></p><p>Ps: ExecStart参数为现在服务安装路径 kafka.server参数为要监控的kafka地址，可多个。</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kafka exporter
<span class="nv">After</span><span class="o">=</span>network-online.target
<span class="o">[</span>Service]
<span class="nv">User</span><span class="o">=</span>root
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">ExecStart</span><span class="o">=</span>/opt/software/kafka-exporter/kafka_exporter <span class="se">\</span>
<span class="nt">--kafka</span>.server<span class="o">=</span>cdh-xxx:9092
<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div><p>重新加载systemd系统</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload 
systemctl start kafka-exporter 
systemctl <span class="nb">enable </span>kafka-exporter.service
</code></pre></div></div><p>检查服务状态<br /> <code class="language-plaintext highlighter-rouge">systemctl status kafka-exporter</code></p><h3 id="kafka-minion-ps适用于加权限的kafka">Kafka-minion ps:适用于加权限的kafka</h3><p>节点规划</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip
port
x.x.x.x
9101
</code></pre></div></div><p>解压缩事先下载好的kafka-minion二进制包到/user/local/kafka-minion目录下</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tar</span> <span class="nt">-zxvf</span> kafka_minion-1.0.2.tar.gz <span class="nt">-C</span> /root/software/
<span class="nb">cd</span> /opt/software/
</code></pre></div></div><p>编辑host文件，适配大数据平台<br /> <code class="language-plaintext highlighter-rouge">vim/etc/hosts</code></p><p>若kafka集群有域名地址<br /> 添加如下内容<br /> <code class="language-plaintext highlighter-rouge">x.x.x.x cdh-xxx</code></p><p>配置kafka-minion启动脚本<br /> <code class="language-plaintext highlighter-rouge">vi run.sh</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">export </span><span class="nv">KAFKA_BROKERS</span><span class="o">=</span>dbjf-cmh12:9092
<span class="nb">export </span><span class="nv">VERSION</span><span class="o">=</span>1.0.2
<span class="nb">export </span><span class="nv">KAFKA_VERSION</span><span class="o">=</span>2.0.0
<span class="nb">export </span><span class="nv">TELEMETRY_PORT</span><span class="o">=</span>9101 
 
<span class="nb">export </span><span class="nv">KAFKA_SASL_ENABLED</span><span class="o">=</span><span class="nb">true
export </span><span class="nv">KAFKA_SASL_MECHANISM</span><span class="o">=</span>GSSAPI
<span class="nb">export </span><span class="nv">KAFKA_SASL_GSSAPI_AUTH_TYPE</span><span class="o">=</span>KEYTAB_AUTH
<span class="nb">export </span><span class="nv">KAFKA_SASL_GSSAPI_KEY_TAB_PATH</span><span class="o">=</span>/data/rec.keytab
<span class="nb">export </span><span class="nv">KAFKA_SASL_GSSAPI_KERBEROS_CONFIG_PATH</span><span class="o">=</span>/etc/krb5.conf
<span class="nb">export </span><span class="nv">KAFKA_SASL_GSSAPI_SERVICE_NAME</span><span class="o">=</span>kafka
<span class="nb">export </span><span class="nv">KAFKA_SASL_GSSAPI_USERNAME</span><span class="o">=</span>rec
<span class="nb">export </span><span class="nv">KAFKA_SASL_GSSAPI_REALM</span><span class="o">=</span>ZXJTKDC
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">nohup /root/software/kafka-minion/main &amp;</code></p><p>把kafka-minion配置为系统服务<br /> <code class="language-plaintext highlighter-rouge">vim /etc/systemd/system/kafka-minion.service</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Ps: ExecStart参数为现在服务安装路径
 <span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kafka minion
<span class="nv">After</span><span class="o">=</span>network-online.target
<span class="o">[</span>Service]
<span class="nv">User</span><span class="o">=</span>root
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">ExecStart</span><span class="o">=</span>/mnt/software/kafka-minion/run.sh
<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div><p>重新加载systemd系统</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload 
systemctl start kafka-minion
systemctl <span class="nb">enable </span>kafka-minion.service
</code></pre></div></div><p>检查服务状态<br /> <code class="language-plaintext highlighter-rouge">systemctl status kafka-minion</code></p><h3 id="node-exporter安装">Node-exporter安装</h3><p>节点规划</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip
port
localhost
9100
</code></pre></div></div><p>解压缩事先下载好的Node-exporter二进制包到/user/local/node-exporter目录下</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tar</span> <span class="nt">-zxvf</span> node_exporter-0.18.1.linux-amd64.tar.gz <span class="nt">-C</span> /opt/software
<span class="nb">cd</span> /opt/software/
<span class="nb">mv </span>node_exporter-0.18.1.linux-arm64/ node-exporter
</code></pre></div></div><p>把Node-exporter配置为系统服务<br /> <code class="language-plaintext highlighter-rouge">vim /etc/systemd/system/node-exporter.service</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Ps: ExecStart参数为现在服务安装路径
 <span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Node exporter
<span class="nv">After</span><span class="o">=</span>network-online.target
<span class="o">[</span>Service]
<span class="nv">User</span><span class="o">=</span>root
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">ExecStart</span><span class="o">=</span>/opt/software/node-exporter/node_exporter 
<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div><p>重新加载systemd系统</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload 
systemctl start node-exporter 
systemctl <span class="nb">enable </span>node-exporter.service
</code></pre></div></div><p>检查服务状态<br /> <code class="language-plaintext highlighter-rouge">systemctl status node-exporter</code></p><p>浏览器中打开 http://{ip-address}:9100/metrics若能看到相应的指标列表，则安装成功</p><p>【注】：操作系统指标需要被监控的每一台服务器（虚机）上都需要安装.</p><h3 id="postgres-exporter安装">Postgres-exporter安装</h3><p>节点规划</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip
port
localhost
9187
</code></pre></div></div><p>解压缩事先下载好的Postgres-exporter二进制包到/user/local/postgres-exporter目录下</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tar</span> <span class="nt">-zxvf</span> postgres_exporter_v0.8.0_linux-amd64.tar.gz <span class="nt">-C</span> /opt/software
<span class="nb">cd</span> /opt/software
<span class="nb">mv </span>postgres_exporter_v0.8.0_linux-amd64/ postgres-exporter
</code></pre></div></div><p>把Postgres-exporter配置为系统服务<br /> <code class="language-plaintext highlighter-rouge">vim /etc/systemd/system/postgres_exporter.service</code></p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Ps: ExecStart参数为现在服务安装路径
<span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Prometheus PostgreSQL Exporter
<span class="nv">After</span><span class="o">=</span>network.target
<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>simple
<span class="nv">Restart</span><span class="o">=</span>always
<span class="nv">User</span><span class="o">=</span>postgres
<span class="nv">Group</span><span class="o">=</span>postgres
<span class="nv">Environment</span><span class="o">=</span><span class="nv">DATA_SOURCE_NAME</span><span class="o">=</span><span class="s2">"user=postgres host=xxx.xxx.xxx.xxx password='postgres' port=5432 dbname=postgres sslmode=disable"</span>
<span class="nv">ExecStart</span><span class="o">=</span>/opt/software/postgres-exporter/postgres_exporter
<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target 
</code></pre></div></div><p>重新加载systemd系统</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload 
systemctl start postgres-exporter
systemctl <span class="nb">enable </span>postgres-exporter.service
</code></pre></div></div><p>检查服务状态<br /> <code class="language-plaintext highlighter-rouge">systemctl status postgres-exporter.service</code></p><p>Prometheus配置<br /> 更新Prometheus配置文件<br /> <code class="language-plaintext highlighter-rouge">vim /opt/software/prometheus/prometheus.yml</code></p><p>更新配置文件，内容如下：</p><div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Ps:
Prometheus 配置无需更改
node 配置需要按照实际服务器地址填写 可多个
spring boot配置需要按照服务所在服务器ip 端口填写
Postgres 若是安装在同一台机器则不需要改
scrape_configs:
  - job_name: <span class="s2">"prometheus"</span>
    static_configs:
      - targets: <span class="o">[</span><span class="s2">"localhost:9090"</span><span class="o">]</span>
 
  - job_name: <span class="s2">"kafka"</span>
    static_configs:
      - targets: <span class="o">[</span><span class="s2">"localhost:9308"</span><span class="o">]</span>
 
  - job_name: <span class="s2">"kafka-minion"</span>
    static_configs:
      - targets: <span class="o">[</span><span class="s2">"localhost:9101"</span><span class="o">]</span>
 
  - job_name: <span class="s2">"node"</span>
    static_configs:
    - targets: <span class="o">[</span><span class="s2">"localhost:9100"</span><span class="o">]</span>
 
  - job_name: <span class="s2">"springboot"</span>
    metrics_path: /management/prometheus
    scrape_interval: 5s
    static_configs:
      - targets:
          - localhost:7020
          - localhost:7030
          - localhost:7100
          - localhost:7110
          - localhost:7120
          - localhost:7200
          - localhost:7350
          - localhost:7410
          - localhost:7430
          - localhost:7500
          - localhost:7510
          - localhost:7590
          - localhost:7600
          - localhost:8080
  
  - job_name: <span class="s2">"postgres"</span>
    static_configs:
      - targets: <span class="o">[</span><span class="s2">"localhost:9187"</span><span class="o">]</span> 
</code></pre></div></div><p>Grafana配置<br /> 首先以默认的的管理员账号登录admin/admin</p><p>配置Prometheus数据源</p><p>Grafana菜单栏选择Data Sources</p><p>点击[Add]按钮后选择“Prometheus”</p><p>配置Prometheus服务器的信息，如下图所示</p><p>【注】localhost更换为Prometheus服务的IP地址。</p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://lewinz.org" target="_blank">Lewin</a></li><li>本文链接：<a href="https://lewinz.org/wiki/middleware/" target="_blank">https://lewinz.org/wiki/middleware/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名</li></ul></div></article><div class="share"><div class="share-component" data-disabled='qq,weibo,qzone'></div></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/wiki/middleware/', clientID: '831a35f6d4f6fc049209', clientSecret: '6e80f9a3e9b50b498553e32179ad3adbd893ab7e', repo: 'blog-comments', owner: 'Lewinz', admin: ['Lewinz'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@built/assets/search_data.json?v=1626963691', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7093222719567591" data-ad-slot="5263168187" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2021 <span title="Lewin">Lewin</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/Lewinz/lewinz.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://lewinz.org/" title="首页" target="">首页</a></li><li> <a href="https://lewinz.org/categories/" title="分类" target="">分类</a></li><li> <a href="https://lewinz.org/wiki/" title="维基" target="">维基</a></li><li> <a href="https://lewinz.org/links/" title="链接" target="">链接</a></li><li> <a href="https://lewinz.org/about/" title="关于" target="">关于</a></li><li><a href="https://lewinz.org/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul><script async src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span> <span id="busuanzi_container_page_pv" style="display:none"> / 本页访问量<span id="busuanzi_value_page_pv"></span>次 / 统计始于2021-04-21 </span></div></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/vendor/share.js/dist/js/share.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/Lewinz/lewinz.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-80669434-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
